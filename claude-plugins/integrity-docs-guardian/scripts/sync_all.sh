#!/bin/bash
################################################################################
# sync_all.sh - Orchestrateur global √âMERGENCE
# Coordonne tous les agents, fusionne les rapports et synchronise les d√©p√¥ts
################################################################################

set -e

# Couleurs pour l'output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
# Remonte de scripts/ -> integrity-docs-guardian/ -> claude-plugins/ -> REPO_ROOT
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)"
PLUGIN_DIR="$REPO_ROOT/claude-plugins/integrity-docs-guardian"
REPORTS_DIR="$PLUGIN_DIR/reports"
SCRIPTS_DIR="$PLUGIN_DIR/scripts"

# Cr√©er les r√©pertoires n√©cessaires
mkdir -p "$REPORTS_DIR"

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë                                                                ‚ïë${NC}"
echo -e "${BLUE}‚ïë          üöÄ ORCHESTRATEUR GLOBAL √âMERGENCE                     ‚ïë${NC}"
echo -e "${BLUE}‚ïë          Synchronisation Multi-Agents & Multi-Sources          ‚ïë${NC}"
echo -e "${BLUE}‚ïë                                                                ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# Timestamp de d√©but
START_TIME=$(date +%s)
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

echo -e "${BLUE}üïí D√©marrage:${NC} $TIMESTAMP"
echo ""

################################################################################
# √âTAPE 1: D√âTECTION DU CONTEXTE
################################################################################

echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}üìç √âTAPE 1: D√âTECTION DU CONTEXTE${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

CURRENT_COMMIT=$(git rev-parse HEAD)
CURRENT_BRANCH=$(git branch --show-current)

echo "   üìç Commit actuel: ${CURRENT_COMMIT:0:8}"
echo "   üåø Branche: $CURRENT_BRANCH"
echo ""

################################################################################
# √âTAPE 2: EX√âCUTION DES AGENTS
################################################################################

echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}ü§ñ √âTAPE 2: EX√âCUTION DES AGENTS${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

AGENTS_SUCCESS=0
AGENTS_TOTAL=3

# Agent 1: Anima (DocKeeper)
echo -e "${BLUE}üìö [1/3] Lancement d'Anima (DocKeeper)...${NC}"
if (command -v python &> /dev/null || command -v python3 &> /dev/null) && [ -f "$SCRIPTS_DIR/scan_docs.py" ]; then
    PYTHON_CMD=$(command -v python3 2>/dev/null || command -v python 2>/dev/null)
    if $PYTHON_CMD "$SCRIPTS_DIR/scan_docs.py" > /dev/null 2>&1; then
        echo -e "   ${GREEN}‚úÖ Anima termin√© avec succ√®s${NC}"
        ((AGENTS_SUCCESS++))
    else
        echo -e "   ${YELLOW}‚ö†Ô∏è  Anima a d√©tect√© des probl√®mes (voir reports/docs_report.json)${NC}"
    fi
else
    echo -e "   ${YELLOW}‚ö†Ô∏è  Anima non disponible${NC}"
fi
echo ""

# Agent 2: Neo (IntegrityWatcher)
echo -e "${BLUE}üîê [2/3] Lancement de Neo (IntegrityWatcher)...${NC}"
if (command -v python &> /dev/null || command -v python3 &> /dev/null) && [ -f "$SCRIPTS_DIR/check_integrity.py" ]; then
    PYTHON_CMD=$(command -v python3 2>/dev/null || command -v python 2>/dev/null)
    if $PYTHON_CMD "$SCRIPTS_DIR/check_integrity.py" > /dev/null 2>&1; then
        echo -e "   ${GREEN}‚úÖ Neo termin√© avec succ√®s${NC}"
        ((AGENTS_SUCCESS++))
    else
        echo -e "   ${YELLOW}‚ö†Ô∏è  Neo a d√©tect√© des incoh√©rences (voir reports/integrity_report.json)${NC}"
    fi
else
    echo -e "   ${YELLOW}‚ö†Ô∏è  Neo non disponible${NC}"
fi
echo ""

# Agent 3: ProdGuardian (Production Monitor)
echo -e "${BLUE}‚òÅÔ∏è  [3/3] Lancement de ProdGuardian (Production Monitor)...${NC}"
if (command -v python &> /dev/null || command -v python3 &> /dev/null) && command -v gcloud &> /dev/null && [ -f "$SCRIPTS_DIR/check_prod_logs.py" ]; then
    PYTHON_CMD=$(command -v python3 2>/dev/null || command -v python 2>/dev/null)
    if $PYTHON_CMD "$SCRIPTS_DIR/check_prod_logs.py" > /dev/null 2>&1; then
        echo -e "   ${GREEN}‚úÖ ProdGuardian termin√© - Production OK${NC}"
        ((AGENTS_SUCCESS++))
    elif [ $? -eq 1 ]; then
        echo -e "   ${YELLOW}‚ö†Ô∏è  ProdGuardian - Production DEGRADED${NC}"
    elif [ $? -eq 2 ]; then
        echo -e "   ${RED}üî¥ ProdGuardian - Production CRITICAL${NC}"
    fi
else
    echo -e "   ${YELLOW}‚ö†Ô∏è  ProdGuardian non disponible (gcloud ou python manquant)${NC}"
fi
echo ""

################################################################################
# √âTAPE 3: FUSION DES RAPPORTS
################################################################################

echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}üìä √âTAPE 3: FUSION DES RAPPORTS${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

if [ -f "$SCRIPTS_DIR/merge_reports.py" ]; then
    echo -e "${BLUE}üîÑ Fusion des rapports en cours...${NC}"
    PYTHON_CMD=$(command -v python3 2>/dev/null || command -v python 2>/dev/null)
    $PYTHON_CMD "$SCRIPTS_DIR/merge_reports.py"
    MERGE_EXIT_CODE=$?

    if [ $MERGE_EXIT_CODE -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Fusion termin√©e - Statut global: OK${NC}"
    elif [ $MERGE_EXIT_CODE -eq 1 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Fusion termin√©e - Statut global: DEGRADED/WARNING${NC}"
    elif [ $MERGE_EXIT_CODE -eq 2 ]; then
        echo -e "${RED}üî¥ Fusion termin√©e - Statut global: CRITICAL${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Script merge_reports.py introuvable${NC}"
fi
echo ""

################################################################################
# √âTAPE 4: V√âRIFICATION DES CHANGEMENTS
################################################################################

echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}üîç √âTAPE 4: V√âRIFICATION DES CHANGEMENTS${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# V√©rifier s'il y a des modifications √† committer
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${BLUE}üìù Modifications d√©tect√©es:${NC}"
    git status --short | head -10
    echo ""

    # Demander confirmation pour commit (sauf si AUTO_COMMIT=1)
    if [ "$AUTO_COMMIT" = "1" ]; then
        COMMIT_CHANGES=true
    else
        echo -e "${YELLOW}Voulez-vous committer ces changements? (y/N)${NC}"
        read -r -p "> " RESPONSE
        if [[ "$RESPONSE" =~ ^[Yy]$ ]]; then
            COMMIT_CHANGES=true
        else
            COMMIT_CHANGES=false
        fi
    fi

    if [ "$COMMIT_CHANGES" = true ]; then
        echo ""
        echo -e "${BLUE}üì§ Commit des modifications...${NC}"
        git add .
        COMMIT_MSG="chore(sync): mise √† jour automatique - agents √âMERGENCE $(date +%F_%T)"
        git commit -m "$COMMIT_MSG" || echo "Rien √† committer"
        echo -e "${GREEN}‚úÖ Commit effectu√©${NC}"
    else
        echo -e "${YELLOW}‚è≠Ô∏è  Commit ignor√©${NC}"
    fi
else
    echo -e "${GREEN}‚úÖ Aucune modification √† committer${NC}"
fi
echo ""

################################################################################
# √âTAPE 5: SYNCHRONISATION GITHUB
################################################################################

echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}üîó √âTAPE 5: SYNCHRONISATION GITHUB${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

if [ "$SKIP_PUSH" != "1" ]; then
    # V√©rifier si origin existe
    if git remote get-url origin &> /dev/null; then
        echo -e "${BLUE}üì§ Push vers GitHub (origin/$CURRENT_BRANCH)...${NC}"
        if git push origin "$CURRENT_BRANCH" 2>&1; then
            echo -e "${GREEN}‚úÖ Synchronis√© avec GitHub${NC}"
        else
            echo -e "${RED}‚ùå Erreur lors du push vers GitHub${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Remote 'origin' non configur√©${NC}"
    fi
else
    echo -e "${YELLOW}‚è≠Ô∏è  Push vers GitHub ignor√© (SKIP_PUSH=1)${NC}"
fi
echo ""

################################################################################
# √âTAPE 6: SYNCHRONISATION CODEX CLOUD (optionnel)
################################################################################

echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}‚òÅÔ∏è  √âTAPE 6: SYNCHRONISATION CODEX CLOUD${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

if [ "$SKIP_PUSH" != "1" ]; then
    # V√©rifier si remote codex existe
    if git remote get-url codex &> /dev/null; then
        echo -e "${BLUE}üì§ Push vers Codex Cloud (codex/$CURRENT_BRANCH)...${NC}"
        if git push codex "$CURRENT_BRANCH" 2>&1; then
            echo -e "${GREEN}‚úÖ Synchronis√© avec Codex Cloud${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  Erreur lors du push vers Codex (peut ne pas exister)${NC}"
        fi
    else
        echo -e "${YELLOW}‚ÑπÔ∏è  Remote 'codex' non configur√© (optionnel)${NC}"
    fi
else
    echo -e "${YELLOW}‚è≠Ô∏è  Push vers Codex ignor√© (SKIP_PUSH=1)${NC}"
fi
echo ""

################################################################################
# √âTAPE 7: RAPPORT FINAL
################################################################################

echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}üìã RAPPORT FINAL${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Calculer la dur√©e
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo -e "${GREEN}‚úÖ Synchronisation termin√©e !${NC}"
echo ""
echo "   üïí Dur√©e totale: ${DURATION}s"
echo "   ü§ñ Agents ex√©cut√©s: $AGENTS_SUCCESS/$AGENTS_TOTAL"
echo "   üìÅ Rapports g√©n√©r√©s: $REPORTS_DIR"
echo ""

# Afficher le statut du rapport global si disponible
if [ -f "$REPORTS_DIR/global_report.json" ]; then
    echo "   üìä Rapport global: $REPORTS_DIR/global_report.json"

    # Extraire le statut avec jq si disponible
    if command -v jq &> /dev/null; then
        GLOBAL_STATUS=$(jq -r '.statut_global' "$REPORTS_DIR/global_report.json" 2>/dev/null)
        if [ "$GLOBAL_STATUS" = "OK" ]; then
            echo -e "   ${GREEN}üü¢ Statut global: $GLOBAL_STATUS${NC}"
        elif [ "$GLOBAL_STATUS" = "DEGRADED" ] || [ "$GLOBAL_STATUS" = "WARNING" ]; then
            echo -e "   ${YELLOW}üü° Statut global: $GLOBAL_STATUS${NC}"
        elif [ "$GLOBAL_STATUS" = "CRITICAL" ]; then
            echo -e "   ${RED}üî¥ Statut global: $GLOBAL_STATUS${NC}"
        fi
    fi
fi
echo ""

################################################################################
# FEEDBACK AUTOMATIQUE - STATUT DES AGENTS
################################################################################

echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}üßæ FEEDBACK AUTOMATIQUE - STATUT DES AGENTS${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Fonction pour v√©rifier la fra√Æcheur d'un rapport (< 5 min = frais)
check_report_freshness() {
    local report_file=$1
    local agent_name=$2

    if [ ! -f "$report_file" ]; then
        echo -e "   ${RED}‚ùå $agent_name${NC} - Rapport absent"
        return 1
    fi

    # V√©rifier l'√¢ge du fichier (en secondes)
    local file_age=$(($(date +%s) - $(stat -c %Y "$report_file" 2>/dev/null || stat -f %m "$report_file" 2>/dev/null)))

    if [ $file_age -lt 300 ]; then  # < 5 minutes
        # Extraire le statut si possible
        if command -v jq &> /dev/null; then
            local status=$(jq -r '.status // .statut // "unknown"' "$report_file" 2>/dev/null)
            if [ "$status" = "ok" ] || [ "$status" = "OK" ]; then
                echo -e "   ${GREEN}‚úÖ $agent_name${NC} - OK (rapport frais)"
            elif [ "$status" = "needs_update" ] || [ "$status" = "warning" ] || [ "$status" = "WARNING" ]; then
                echo -e "   ${YELLOW}‚ö†Ô∏è  $agent_name${NC} - Attention requise (voir rapport)"
            elif [ "$status" = "critical" ] || [ "$status" = "CRITICAL" ]; then
                echo -e "   ${RED}üî¥ $agent_name${NC} - CRITIQUE (action imm√©diate requise)"
            else
                echo -e "   ${GREEN}‚úÖ $agent_name${NC} - Rapport frais"
            fi
        else
            echo -e "   ${GREEN}‚úÖ $agent_name${NC} - Rapport frais (< 5 min)"
        fi
        return 0
    else
        echo -e "   ${YELLOW}‚ö†Ô∏è  $agent_name${NC} - Dernier rapport > 5 min (pas ex√©cut√© r√©cemment)"
        return 1
    fi
}

# V√©rifier chaque agent
check_report_freshness "$REPORTS_DIR/docs_report.json" "Anima (DocKeeper)"
check_report_freshness "$REPORTS_DIR/integrity_report.json" "Neo (IntegrityWatcher)"
check_report_freshness "$REPORTS_DIR/unified_report.json" "Nexus (Coordinator)"
check_report_freshness "$REPORTS_DIR/prod_report.json" "ProdGuardian"

echo ""
echo -e "${BLUE}üí° Commandes disponibles:${NC}"
echo "   ‚Ä¢ /check_docs        - V√©rifier la documentation (Anima)"
echo "   ‚Ä¢ /check_integrity   - V√©rifier l'int√©grit√© (Neo)"
echo "   ‚Ä¢ /guardian_report   - Rapport unifi√© (Nexus)"
echo "   ‚Ä¢ /check_prod        - Surveiller production (ProdGuardian)"
echo "   ‚Ä¢ /sync_all          - Orchestration compl√®te"
echo "   ‚Ä¢ /audit_agents      - Audit complet du syst√®me"
echo ""

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë          ‚úÖ ORCHESTRATION TERMIN√âE                             ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# Code de sortie bas√© sur le statut global
if [ -f "$REPORTS_DIR/global_report.json" ] && command -v jq &> /dev/null; then
    GLOBAL_STATUS=$(jq -r '.statut_global' "$REPORTS_DIR/global_report.json" 2>/dev/null)
    if [ "$GLOBAL_STATUS" = "CRITICAL" ]; then
        exit 2
    elif [ "$GLOBAL_STATUS" = "DEGRADED" ] || [ "$GLOBAL_STATUS" = "WARNING" ]; then
        exit 1
    fi
fi

exit 0
