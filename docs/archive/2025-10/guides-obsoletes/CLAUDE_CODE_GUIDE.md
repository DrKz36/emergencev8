# Guide Claude Code ‚Äî Emergence V8

**Version** : 1.0
**Date** : 2025-10-16
**Agent** : Claude Code (Anthropic)
**Architecte** : FG (validation finale avant commit/push/deploy)

---

## 0. Bienvenue Claude Code

Ce document est votre **guide de r√©f√©rence** pour collaborer efficacement sur le projet Emergence V8 en tant que co-d√©veloppeur IA principal.

Vous travaillez en **√©galit√© technique** avec Codex GPT et d'autres agents IA. Chacun peut modifier n'importe quel fichier du d√©p√¥t, sous validation finale de l'architecte humain (FG).

---

## 1. Lecture obligatoire avant toute session

**Ordre de lecture (RESPECTER CET ORDRE)** :

1. **[AGENT_SYNC.md](AGENT_SYNC.md)** ‚Äî √âtat actuel du d√©p√¥t, progression, d√©ploiement
2. **Ce fichier (CLAUDE_CODE_GUIDE.md)** ‚Äî Consignes sp√©cifiques Claude Code
3. **[CODEV_PROTOCOL.md](CODEV_PROTOCOL.md)** ‚Äî Protocole de co-d√©veloppement multi-agents
4. **[docs/passation.md](docs/passation.md)** ‚Äî Derni√®res 3 entr√©es minimum (contexte, blocages, next actions)
5. **`git status` + `git log --oneline -10`** ‚Äî √âtat Git actuel

**Temps de lecture estim√©** : 10-15 minutes (investissement OBLIGATOIRE pour √©viter erreurs et conflits)

---

## 2. Principes fondamentaux

### 2.1 √âgalit√© technique
- ‚úÖ Vous √™tes un **co-d√©veloppeur** de niveau ing√©nieur √©quivalent √† Codex GPT
- ‚úÖ Vous pouvez modifier **n'importe quel fichier** du d√©p√¥t (backend Python, frontend JavaScript, docs, scripts)
- ‚úÖ Vous pouvez **compl√©ter ou corriger** le travail d'autres agents
- ‚ùå Vous ne pouvez **jamais bloquer** un fichier ou une fonctionnalit√©

### 2.2 Validation architecte
- **L'architecte (FG)** est le seul point de validation avant :
  - `git commit`
  - `git push`
  - D√©ploiement Google Cloud Run
- **Vous ne committez jamais seuls** : vous pr√©parez les changements et les soumettez pour revue

### 2.3 Communication asynchrone
- **Via Git** : commits atomiques, branches explicites
- **Via documentation** : `docs/passation.md` (journal chronologique), `AGENT_SYNC.md` (√©tat global)
- **Pas de canal externe** : tout passe par le d√©p√¥t

---

## 3. Zones de responsabilit√© sugg√©r√©es (non bloquantes)

**Claude Code privil√©gie (mais n'est pas limit√© √†)** :

### Backend Python
- Services : `src/backend/features/*` (chat, memory, auth, admin, etc.)
- Core : `src/backend/core/*` (database, DI, services centraux)
- Shared : `src/backend/shared/*` (utilitaires partag√©s)
- Tests : `tests/backend/*`

### Architecture et Refactoring
- Documentation architecture : `docs/architecture/*` (mod√®les C4)
- Am√©lioration structure et dette technique
- Optimisation performance et scalabilit√©
- Patterns et bonnes pratiques

### Documentation Technique
- Architecture syst√®me : `docs/architecture/*`
- Documentation backend : `docs/backend/*`
- Guides techniques : `docs/Memoire.md`, conventions
- Diagrammes et mod√®les C4

### Tests et Qualit√©
- Tests backend : `pytest`
- Type checking : `mypy`
- Linting : `ruff`
- Smoke tests : PowerShell (`tests/run_all.ps1`)

**Important** : Ces zones sont **indicatives**. Vous pouvez intervenir partout si n√©cessaire, y compris sur le frontend ou les scripts.

---

## 4. Workflow de session

### 4.1 D√©marrage de session

**Checklist obligatoire** :

- [ ] Lire `AGENT_SYNC.md` (√©tat actuel du d√©p√¥t)
- [ ] Lire ce fichier (`CLAUDE_CODE_GUIDE.md`)
- [ ] Lire `CODEV_PROTOCOL.md` (protocole inter-agents)
- [ ] Lire les 3 derni√®res entr√©es de `docs/passation.md`
- [ ] Ex√©cuter `git status` et `git log --oneline -10`
- [ ] V√©rifier que l'environnement est propre (pas de fichiers non suivis suspects)

**Environnement** :
- Python 3.11 dans un virtualenv
- Node.js 18+ (via nvm recommand√©)
- Docker (pour tests et d√©ploiement)

**Configuration des permissions** :
- Le fichier `.claude/settings.local.json` contient la configuration des permissions d'ex√©cution automatique
- `"allow": ["*"]` active l'ex√©cution automatique de toutes les op√©rations sans demande d'autorisation
- Cette configuration permet un workflow fluide et continu sans interruption
- Les commandes sp√©cifiques list√©es apr√®s le wildcard sont maintenues pour r√©f√©rence

### 4.2 Pendant le d√©veloppement

**R√®gles d'or** :

1. **Avancer sans interruption** : bouclage de l'ensemble des t√¢ches identifi√©es avant de solliciter l'utilisateur, sauf d√©pendance bloquante
2. **Respecter la structure** : `src/backend`, `src/frontend`, `docs`, etc.
3. **Code complet obligatoire** : pas d'ellipses, pas de fragments (voir ARBO-LOCK)
4. **Tests syst√©matiques** : cr√©er les tests pour tout nouveau fichier
5. **Documentation synchronis√©e** : mettre √† jour `docs/` si changement d'architecture ou de responsabilit√©s

**Anti-patterns √† √©viter** :

- ‚ùå Livrer des fragments de code
- ‚ùå Modifier sans tester
- ‚ùå Ignorer l'architecture existante
- ‚ùå Oublier de documenter dans `docs/passation.md`

### 4.3 Cl√¥ture de session

**Checklist obligatoire** :

- [ ] **Tests backend** (si modifi√©) : `pytest` ‚úÖ
- [ ] **Tests frontend** (si modifi√©) : `npm run build` ‚úÖ
- [ ] **Smoke tests** (si modifi√©) : `pwsh -File tests/run_all.ps1` ‚úÖ
- [ ] **Linters** : `ruff check`, `mypy` (backend) ‚úÖ
- [ ] **Documentation** : mise √† jour `docs/passation.md` (nouvelle entr√©e compl√®te en haut) ‚úÖ
- [ ] **AGENT_SYNC.md** : mise √† jour section "Claude Code" avec timestamp et fichiers touch√©s ‚úÖ
- [ ] **Git propre** : `git status` sans fichiers non suivis suspects ‚úÖ
- [ ] **Passation** : entr√©e compl√®te dans `docs/passation.md` avec format standard ‚úÖ

**Format de passation** (template) :

```markdown
## [YYYY-MM-DD HH:MM] ‚Äî Agent: Claude Code (Sonnet 4.5)

### Fichiers modifi√©s
- `src/backend/features/chat/service.py` (ajout m√©thode export)
- `src/backend/features/chat/router.py` (nouvel endpoint /export)
- `docs/passation.md` (cette entr√©e)

### Contexte
Impl√©mentation feature export conversations en CSV/PDF selon roadmap P0.3.
Ajout endpoint `POST /api/chat/export` avec support formats multiples.
Service int√®gre g√©n√©ration CSV via csv.writer et PDF via reportlab.

### Tests
- ‚úÖ `pytest tests/backend/features/test_export.py` (nouveau)
- ‚úÖ Tests manuels : export CSV fonctionne
- ‚úÖ Tests manuels : export PDF fonctionne
- ‚úÖ `ruff check` + `mypy` sans erreur

### Prochaines actions recommand√©es
1. Ajouter tests d'int√©gration pour endpoint /export
2. Int√©grer frontend avec bouton export (d√©l√©gu√© √† Codex GPT)
3. Documenter feature dans guide utilisateur

### Blocages
Aucun.
```

---

## 5. Tests et qualit√©

### 5.1 Tests backend

**Obligatoire avant toute soumission** :

```bash
# Tests backend complets
pytest

# Tests backend cibl√©s
pytest tests/backend/features/test_chat.py

# Linting backend
ruff check src/backend/
mypy src/backend/
```

### 5.2 Tests frontend (si modifi√©)

```bash
# Build frontend (OBLIGATOIRE)
npm run build

# Tests unitaires (si configur√©s)
npm run test

# Linting (si configur√©)
npm run lint
```

### 5.3 Smoke tests

```bash
# Tests rapides endpoints critiques
pwsh -File tests/run_all.ps1
```

### 5.4 Crit√®res de qualit√©

- ‚úÖ **Aucune erreur** dans `pytest`
- ‚úÖ **Coverage >80%** pour nouveau code (si tests unitaires configur√©s)
- ‚úÖ **Pas de secrets** dans le code (v√©rifier `git diff`)
- ‚úÖ **Documentation √† jour** (`docs/passation.md`, architecture si impact√©)

---

## 6. Conventions de code

### 6.1 Backend Python

**Style** :
- PEP 8 (enforced by ruff)
- Type hints syst√©matiques (checked by mypy)
- snake_case pour variables/fonctions
- PascalCase pour classes
- UPPER_SNAKE_CASE pour constantes

**Exemple** :
```python
# ‚úÖ Bon
class ChatService:
    def __init__(self, db_manager: DatabaseManager):
        self.db = db_manager
        self._cache: dict[str, Any] = {}

    async def send_message(self, text: str, user_id: int) -> Message:
        """Send a message and return the created message."""
        result = await self.db.execute(
            "INSERT INTO messages (text, user_id) VALUES (?, ?)",
            (text, user_id)
        )
        return Message(id=result.lastrowid, text=text, user_id=user_id)

# ‚ùå Mauvais
class chatService:  # Mauvaise casse
    def sendMessage(self, text, userId):  # Pas de type hints, camelCase
        result = self.db.execute("INSERT INTO messages (text, user_id) VALUES (?, ?)", (text, userId))
        return result  # Type de retour non clair
```

**Structure** :
- Un module par feature (pas de mega-fichiers)
- S√©paration router / service / models
- Dependency injection via dependency.py
- Logs structur√©s avec prefixes

### 6.2 Frontend JavaScript (si modifi√©)

**Style** :
- ES6+ moderne (async/await, arrow functions, destructuring)
- Modules ESM (import/export)
- PascalCase pour classes/composants
- camelCase pour variables/fonctions
- UPPER_SNAKE_CASE pour constantes

**Exemple** :
```javascript
// ‚úÖ Bon
class ChatModule {
  async sendMessage(text) {
    const result = await this.apiClient.post('/api/chat/message', { text });
    return result;
  }
}

// ‚ùå Mauvais
function send_message(text) {  // snake_case non recommand√© en JS
  return fetch('/api/chat/message', { method: 'POST', body: text });  // pas async/await
}
```

### 6.3 Documentation Markdown

**Style** :
- Titres hi√©rarchiques (`#`, `##`, `###`)
- Listes √† puces ou num√©rot√©es
- Blocs de code avec syntaxe highlight (```bash, ```javascript, ```python)
- Tables pour donn√©es structur√©es
- √âmojis pour signalisation visuelle (‚úÖ, ‚ùå, ‚ö†Ô∏è, üöÄ, üìã)

---

## 7. Architecture et r√©f√©rences

### 7.1 Documentation architecture

**Lire avant toute modification structurelle** :

- [docs/architecture/00-Overview.md](docs/architecture/00-Overview.md) ‚Äî Vue C4 Contexte & Conteneurs
- [docs/architecture/10-Components.md](docs/architecture/10-Components.md) ‚Äî Composants backend/frontend
- [docs/architecture/30-Contracts.md](docs/architecture/30-Contracts.md) ‚Äî Contrats API et WebSocket
- [docs/Memoire.md](docs/Memoire.md) ‚Äî Syst√®me m√©moire STM/LTM

### 7.2 Structure du projet

```
emergenceV8/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ backend/          # Backend Python (FastAPI)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/         # Services centraux (DB, DI)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ features/     # Features (chat, memory, auth, etc.)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shared/       # Utilitaires partag√©s
‚îÇ   ‚îî‚îÄ‚îÄ frontend/         # Frontend JavaScript (ESM)
‚îÇ       ‚îú‚îÄ‚îÄ core/         # StateManager, WebSocket, EventBus
‚îÇ       ‚îú‚îÄ‚îÄ features/     # Modules UI (chat, dashboard, etc.)
‚îÇ       ‚îú‚îÄ‚îÄ components/   # Composants r√©utilisables
‚îÇ       ‚îî‚îÄ‚îÄ styles/       # CSS global et modules
‚îú‚îÄ‚îÄ docs/                 # Documentation technique
‚îÇ   ‚îú‚îÄ‚îÄ architecture/     # Docs architecture (C4)
‚îÇ   ‚îú‚îÄ‚îÄ backend/          # Docs backend par feature
‚îÇ   ‚îî‚îÄ‚îÄ passation.md      # Journal inter-agents
‚îú‚îÄ‚îÄ scripts/              # Scripts PowerShell/Bash
‚îú‚îÄ‚îÄ tests/                # Tests backend/frontend
‚îú‚îÄ‚îÄ AGENT_SYNC.md         # √âtat synchronisation inter-agents
‚îú‚îÄ‚îÄ CODEV_PROTOCOL.md     # Protocole co-d√©veloppement
‚îú‚îÄ‚îÄ CLAUDE_CODE_GUIDE.md  # Ce fichier
‚îî‚îÄ‚îÄ README.md             # Documentation principale
```

### 7.3 Endpoints backend principaux

**Chat** :
- `POST /api/chat/message` ‚Äî Envoyer un message
- `GET /api/threads` ‚Äî Liste des conversations
- `WS /ws/{session_id}` ‚Äî WebSocket temps r√©el

**M√©moire** :
- `POST /api/memory/tend-garden` ‚Äî Consolidation m√©moire
- `POST /api/memory/clear` ‚Äî Reset m√©moire
- `GET /api/memory/stats` ‚Äî Statistiques m√©moire

**Dashboard** :
- `GET /api/dashboard/costs/summary` ‚Äî R√©sum√© co√ªts
- `GET /api/dashboard/timeline/activity` ‚Äî Timeline activit√©
- `GET /api/admin/dashboard/global` ‚Äî Stats globales (admin)

**Auth** :
- `POST /api/auth/login` ‚Äî Connexion
- `POST /api/auth/logout` ‚Äî D√©connexion
- `POST /api/auth/request-password-reset` ‚Äî R√©initialisation mot de passe

---

## 8. Git et d√©ploiement

### 8.1 Workflow Git

**Branche principale** : `main`

**Workflow** :
1. Toujours travailler sur `main` ou branche feature explicite
2. `git fetch --all --prune` avant de commencer
3. `git rebase origin/main` si n√©cessaire
4. Tests + documentation
5. Pr√©parer les changements (pas de commit direct)
6. Soumettre √† l'architecte pour validation

**Politique de merge** :
- **Squash merge** pour toutes les Pull Requests
- Commits individuels regroup√©s en un seul commit sur `main`
- Voir `docs/git-workflow.md` pour proc√©dure compl√®te

### 8.2 D√©ploiement Cloud Run

**Production** :
- URL : https://emergence-app.ch
- Projet GCP : `emergence-469005`
- R√©gion : `europe-west1`
- Service : `emergence-app`

**Proc√©dure recommand√©e** :
- **D√©ploiement canary** (progressif) : voir [CANARY_DEPLOYMENT.md](CANARY_DEPLOYMENT.md)
- Script automatis√© : `pwsh -File scripts/deploy-canary.ps1`
- Ancienne m√©thode (d√©conseill√©e) : d√©ploiement direct

**NE PAS d√©ployer sans validation architecte** ‚ùå

---

## 9. Sub-Agents et outils de surveillance

### 9.1 Sub-Agents disponibles (Slash Commands)

**Anima** (`/check_docs`) : V√©rifie coh√©rence code/documentation
**Neo** (`/check_integrity`) : D√©tecte incoh√©rences backend/frontend
**Nexus** (`/guardian_report`) : Synth√©tise rapports Anima et Neo
**ProdGuardian** (`/check_prod`) : Analyse logs Cloud Run

**Ces agents sugg√®rent automatiquement la mise √† jour de AGENT_SYNC.md** quand ils d√©tectent des changements structurels importants.

### 9.2 Utilisation des sub-agents

**Quand utiliser** :
- Apr√®s modifications structurelles importantes
- Avant soumission pour validation
- Pour v√©rifier coh√©rence globale du projet
- Pour d√©tecter r√©gressions potentielles

**Comment utiliser** :
```bash
# Via slash commands
/check_docs        # Anima v√©rifie documentation
/check_integrity   # Neo v√©rifie int√©grit√© code
/guardian_report   # Nexus synth√©tise tout
/check_prod        # ProdGuardian analyse production
```

---

## 10. Ressources et support

### 10.1 Documentation cl√©

**Roadmap et planning** :
- [ROADMAP_OFFICIELLE.md](ROADMAP_OFFICIELLE.md) ‚Äî Roadmap unique et officielle
- [ROADMAP_PROGRESS.md](ROADMAP_PROGRESS.md) ‚Äî Suivi quotidien (61% compl√©t√©)
- [CHANGELOG.md](CHANGELOG.md) ‚Äî Historique des versions

**Guides techniques** :
- [docs/backend/](docs/backend/) ‚Äî Documentation backend par feature
- [docs/frontend/](docs/frontend/) ‚Äî Documentation frontend
- [docs/tests/PHASE1_VALIDATION_CHECKLIST.md](docs/tests/PHASE1_VALIDATION_CHECKLIST.md) ‚Äî Checklist validation

**Conventions de d√©veloppement** :
- [docs/AGENTS_COORDINATION.md](docs/AGENTS_COORDINATION.md) ‚Äî Conventions obligatoires inter-agents
- [docs/INTER_AGENT_SYNC.md](docs/INTER_AGENT_SYNC.md) ‚Äî Points de synchronisation

### 10.2 Support

**En cas de probl√®me** :
1. V√©rifier `docs/passation.md` (derni√®res entr√©es)
2. Consulter `AGENT_SYNC.md` (√©tat global)
3. Lire documentation architecture (`docs/architecture/`)
4. Documenter le blocage dans `docs/passation.md`
5. Demander validation architecte

**Logs et monitoring** :
- Cloud Logging : https://console.cloud.google.com/logs
- Cloud Run Console : https://console.cloud.google.com/run
- Health check : https://emergence-app.ch/api/health

---

## 11. Checklist express

### Avant de commencer
- [ ] Lire `AGENT_SYNC.md`
- [ ] Lire `CODEV_PROTOCOL.md`
- [ ] Lire `docs/passation.md` (3 derni√®res entr√©es)
- [ ] `git status` propre
- [ ] Environnement pr√™t (Node.js 18+, Python 3.11)

### Pendant le d√©veloppement
- [ ] Code complet (pas de fragments)
- [ ] Tests cr√©√©s pour nouveau code
- [ ] Documentation synchronis√©e

### Avant de soumettre
- [ ] `pytest` ‚úÖ
- [ ] `npm run build` (si frontend modifi√©) ‚úÖ
- [ ] `git diff` relu (pas de secrets)
- [ ] `docs/passation.md` mis √† jour ‚úÖ
- [ ] `AGENT_SYNC.md` mis √† jour ‚úÖ

---

## 12. √âvolution du guide

Ce guide est **vivant** et peut √™tre amend√© par :
1. Proposition dans `docs/passation.md`
2. Discussion avec l'architecte
3. Mise √† jour de ce fichier avec version incr√©ment√©e

---

**En cas de doute, toujours privil√©gier : tests > documentation > communication.**

**Bienvenue dans l'√©quipe Claude Code ! üöÄ**
