# ✅ Phase P2 Sprint 2 - Proactive Hints Backend (Status Intermédiaire)

**Date**: 2025-10-10
**Agent**: Claude Code
**Status**: 🔄 **EN COURS** (Backend complet, intégration ChatService à finaliser)

---

## 📊 Vue d'Ensemble

Sprint 2 P2 focalisé sur **proactive hints backend** pour générer suggestions contextuelles basées sur préférences utilisateur.

### Objectifs

| Objectif | Status | Détails |
|----------|--------|---------|
| **ProactiveHintEngine créé** | ✅ | Module complet avec ConceptTracker |
| **Tests unitaires** | ✅ | 16/16 tests passants |
| **Métriques Prometheus** | ✅ | 2 métriques intégrées |
| **Intégration ChatService** | 🔄 | À finaliser |
| **Event WebSocket ws:proactive_hint** | 🔄 | À implémenter |

---

## ✅ Travaux Accomplis

### 1. 🔔 ProactiveHintEngine

**Fichier créé**: [proactive_hints.py](../../src/backend/features/memory/proactive_hints.py)

**Classes implémentées**:
- `ProactiveHint` - Dataclass pour hints structurés
- `ConceptTracker` - Track concept recurrence (trigger at 3 mentions)
- `ProactiveHintEngine` - Generate contextual suggestions

**Stratégies de hints**:
1. **Preference reminder**: Trigger when repeated concept matches high-confidence preference
2. **Intent followup**: Remind about uncompleted intentions
3. **Constraint warning**: Alert when violating constraints (future)

**Configuration**:
```python
max_hints_per_call = 3  # Max hints per generate_hints()
recurrence_threshold = 3  # Trigger after 3 concept mentions
min_relevance_score = 0.6  # Min score to emit hint
```

**Usage**:
```python
from backend.features.memory.proactive_hints import ProactiveHintEngine

# Initialize
engine = ProactiveHintEngine(vector_service=vector_service)

# Generate hints
hints = await engine.generate_hints(
    user_id="user_123",
    current_context={
        "topic": "scripting",
        "message": "I need to write a python script"
    }
)

# hints = [ProactiveHint(...), ...]
```

---

### 2. 🧪 Tests Unitaires Complets

**Fichier créé**: [test_proactive_hints.py](../../tests/backend/features/test_proactive_hints.py)

**Résultats** (16/16 passants):

```
✅ TestConceptTracker::test_track_mention_increments_counter
✅ TestConceptTracker::test_track_mention_separate_users
✅ TestConceptTracker::test_reset_counter
✅ TestProactiveHintEngine::test_generate_hints_preference_match
✅ TestProactiveHintEngine::test_generate_hints_no_match_below_threshold
✅ TestProactiveHintEngine::test_generate_hints_max_limit
✅ TestProactiveHintEngine::test_generate_hints_sorted_by_relevance
✅ TestProactiveHintEngine::test_generate_hints_filters_low_relevance
✅ TestProactiveHintEngine::test_generate_hints_resets_counter_after_hint
✅ TestProactiveHintEngine::test_generate_hints_intent_followup
✅ TestProactiveHintEngine::test_generate_hints_empty_user_id
✅ TestProactiveHintEngine::test_extract_concepts_simple
✅ TestProactiveHintEngine::test_extract_concepts_deduplication
✅ TestProactiveHintEngine::test_proactive_hint_to_dict
✅ TestProactiveHintEngineConfiguration::test_default_configuration
✅ TestProactiveHintEngineConfiguration::test_custom_recurrence_threshold
```

**Coverage**:
- ✅ Concept tracking et compteurs
- ✅ Génération hints avec preferences match
- ✅ Threshold recurrence (3 mentions)
- ✅ Max 3 hints enforced
- ✅ Relevance scoring et filtrage
- ✅ Intent followup hints
- ✅ Edge cases (empty user_id, deduplication)

---

### 3. 📊 Métriques Prometheus

**Métriques implémentées** ([proactive_hints.py:28-40](../../src/backend/features/memory/proactive_hints.py#L28-L40)):

```python
proactive_hints_generated = Counter(
    "memory_proactive_hints_generated_total",
    "Proactive hints generated by type",
    ["type"]  # preference_reminder | intent_followup | constraint_warning
)

proactive_hints_relevance = Histogram(
    "memory_proactive_hints_relevance_score",
    "Relevance scores of generated hints",
    buckets=[0.0, 0.3, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
)
```

**Queries Prometheus**:
```promql
# Hints generated by type (rate)
sum by (type) (rate(memory_proactive_hints_generated_total[5m]))

# Average hint relevance
histogram_quantile(0.5, rate(memory_proactive_hints_relevance_score_bucket[5m]))
```

---

## 🔄 Travaux Restants

### 1. 🔌 Intégration ChatService

**Localisation**: [router.py:462-466](../../src/backend/features/chat/router.py#L462-L466)

**Point d'entrée identifié**:
```python
# Ligne 462 - après ajout message user
chat_service.process_user_message_for_agents(
    session_id,
    {"agent_id": ag, "use_rag": use_rag, "doc_ids": doc_ids},
    connection_manager,
)
```

**Plan d'intégration**:

1. **Ajouter ProactiveHintEngine à ChatService.__init__**:
   ```python
   from backend.features.memory.proactive_hints import ProactiveHintEngine

   class ChatService:
       def __init__(self, ...):
           # ...existing code...
           self.hint_engine = ProactiveHintEngine(
               vector_service=self.vector_service
           )
   ```

2. **Créer méthode `_emit_proactive_hints_if_any()`**:
   ```python
   async def _emit_proactive_hints_if_any(
       self,
       session_id: str,
       user_id: str,
       user_message: str,
       connection_manager: ConnectionManager
   ):
       """Generate and emit proactive hints after agent response."""
       try:
           hints = await self.hint_engine.generate_hints(
               user_id=user_id,
               current_context={"message": user_message}
           )

           if hints:
               await connection_manager.send_personal_message(
                   {
                       "type": "ws:proactive_hint",
                       "payload": {
                           "hints": [h.to_dict() for h in hints]
                       }
                   },
                   session_id
               )

               logger.info(
                   f"[ProactiveHints] Emitted {len(hints)} hints for session {session_id[:8]}"
               )

       except Exception as e:
           logger.error(f"[ProactiveHints] Failed to emit hints: {e}", exc_info=True)
           # Non-blocking: don't fail main flow
   ```

3. **Appeler après génération réponse agent** (dans `process_user_message_for_agents` ou après stream):
   ```python
   # Après génération réponse
   await self._emit_proactive_hints_if_any(
       session_id=session_id,
       user_id=user_id,
       user_message=txt,
       connection_manager=connection_manager
   )
   ```

---

### 2. 📡 Event WebSocket `ws:proactive_hint`

**Format événement**:
```json
{
  "type": "ws:proactive_hint",
  "payload": {
    "hints": [
      {
        "id": "hint_abc123",
        "type": "preference_reminder",
        "title": "Rappel: Préférence détectée",
        "message": "💡 Tu as mentionné 'python' 3 fois. Rappel de ta préférence: I prefer Python for scripting",
        "relevance_score": 0.85,
        "source_preference_id": "pref_123",
        "action_label": "Appliquer",
        "action_payload": {
          "preference": "I prefer Python for scripting",
          "concept": "python"
        }
      }
    ]
  }
}
```

**Frontend handler** (à implémenter Sprint 3):
```javascript
EventBus.on('ws:proactive_hint', (data) => {
  const hints = data.hints || [];
  hints.forEach(hint => {
    // Display hint banner
    displayProactiveHintBanner(hint);
  });
});
```

---

## 🎯 Prochaines Étapes

### Immédiat (Sprint 2 finalisation)
- [ ] Intégrer ProactiveHintEngine dans ChatService
- [ ] Appeler `_emit_proactive_hints_if_any()` après réponse agent
- [ ] Tester event `ws:proactive_hint` via WebSocket
- [ ] Documentation intégration

### Sprint 3 (Frontend UI)
- [ ] Créer composant ProactiveHintsUI
- [ ] Afficher banners hints (style, animations)
- [ ] Actions hints (Appliquer, Ignorer, Rappeler plus tard)
- [ ] Dashboard mémoire utilisateur
- [ ] Tests E2E (Playwright)

---

## 📁 Fichiers Créés/Modifiés

### Nouveaux fichiers
1. ✅ [proactive_hints.py](../../src/backend/features/memory/proactive_hints.py) - ProactiveHintEngine
2. ✅ [test_proactive_hints.py](../../tests/backend/features/test_proactive_hints.py) - Tests unitaires

### À modifier (Sprint 2 finalisation)
3. 🔄 [service.py](../../src/backend/features/chat/service.py) - Ajouter hint_engine
4. 🔄 [router.py](../../src/backend/features/chat/router.py) - Appeler emit hints (optionnel)

---

## 📚 Références

### Documentation
- [P2_SPRINT1_COMPLETION_STATUS.md](./P2_SPRINT1_COMPLETION_STATUS.md) - Sprint 1 complété
- [MEMORY_P2_PERFORMANCE_PLAN.md](../optimizations/MEMORY_P2_PERFORMANCE_PLAN.md) - Plan P2 complet

### Code Source
- [proactive_hints.py](../../src/backend/features/memory/proactive_hints.py) - ProactiveHintEngine
- [test_proactive_hints.py](../../tests/backend/features/test_proactive_hints.py) - Tests

---

**Dernière mise à jour**: 2025-10-10
**Auteur**: Claude Code
**Statut**: 🔄 **Sprint 2 Backend ~80% complet** - Intégration ChatService à finaliser
