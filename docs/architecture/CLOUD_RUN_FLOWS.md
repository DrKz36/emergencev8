# ğŸ”„ Flux d'ExÃ©cution - Architecture Cloud Run Ã‰MERGENCE V8

## ğŸ“Š Flux 1 : RequÃªte Chat Utilisateur â†’ RÃ©ponse Agent

### SÃ©quence complÃ¨te (architecture cible)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚
â”‚ Browser â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. POST /api/chat/message {"text": "Bonjour"}
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORCHESTRATEUR (FastAPI Cloud Run)  â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ChatService.handle_message()    â”‚â”‚
â”‚ â”‚                                 â”‚â”‚
â”‚ â”‚ 2. Check Redis cache            â”‚â”‚
â”‚ â”‚    redis.get_session_context()  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚ Cache MISS             â”‚
â”‚           â–¼                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 3. Load context from PostgreSQL â”‚â”‚
â”‚ â”‚    SELECT messages FROM ...     â”‚â”‚
â”‚ â”‚    WHERE session_id = $1        â”‚â”‚
â”‚ â”‚    LIMIT 10                     â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                        â”‚
â”‚           â–¼                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 4. Store user message in DB     â”‚â”‚
â”‚ â”‚    INSERT INTO messages ...     â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                        â”‚
â”‚           â–¼                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 5. RAG: Check if enabled        â”‚â”‚
â”‚ â”‚    if rag_enabled:              â”‚â”‚
â”‚ â”‚      - Check Redis cache        â”‚â”‚
â”‚ â”‚      - Or search pgvector       â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚ RAG docs found         â”‚
â”‚           â–¼                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 6. Build agent task payload     â”‚â”‚
â”‚ â”‚    {                            â”‚â”‚
â”‚ â”‚      "message_id": "uuid",      â”‚â”‚
â”‚ â”‚      "session_id": "uuid",      â”‚â”‚
â”‚ â”‚      "messages": [...],         â”‚â”‚
â”‚ â”‚      "rag_context": [...],      â”‚â”‚
â”‚ â”‚      "model": "claude-3-haiku"  â”‚â”‚
â”‚ â”‚    }                            â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                        â”‚
â”‚           â–¼                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 7. Publish to Pub/Sub           â”‚â”‚
â”‚ â”‚    topic: "agent-anima-tasks"   â”‚â”‚
â”‚ â”‚    data: base64(json(payload))  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Pub/Sub message
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PUB/SUB TOPIC                        â”‚
â”‚ projects/.../topics/agent-anima-tasksâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Push subscription
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORKER: Anima (Cloud Run Service)   â”‚
â”‚                                      â”‚
â”‚ POST /process (Pub/Sub push)         â”‚
â”‚                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 8. Decode Pub/Sub message      â”‚  â”‚
â”‚ â”‚    base64_decode(data)         â”‚  â”‚
â”‚ â”‚    json.loads(...)             â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                          â”‚
â”‚          â–¼                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 9. Call Anthropic API          â”‚  â”‚
â”‚ â”‚    anthropic.messages.create() â”‚  â”‚
â”‚ â”‚      model: claude-3-haiku     â”‚  â”‚
â”‚ â”‚      messages: [...]           â”‚  â”‚
â”‚ â”‚      system: [RAG context]     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚ Response from Claude    â”‚
â”‚          â–¼                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 10. Calculate cost             â”‚  â”‚
â”‚ â”‚     tokens_in * $0.25/1M       â”‚  â”‚
â”‚ â”‚     + tokens_out * $1.25/1M    â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                          â”‚
â”‚          â–¼                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 11. Store in PostgreSQL        â”‚  â”‚
â”‚ â”‚     INSERT INTO messages       â”‚  â”‚
â”‚ â”‚       (session_id, role,       â”‚  â”‚
â”‚ â”‚        content, agent_id,      â”‚  â”‚
â”‚ â”‚        tokens_input, ...)      â”‚  â”‚
â”‚ â”‚     INSERT INTO costs          â”‚  â”‚
â”‚ â”‚       (user_id, cost_usd, ...) â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                          â”‚
â”‚          â–¼                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 12. Notify orchestrator        â”‚  â”‚
â”‚ â”‚     Option A: WebSocket        â”‚  â”‚
â”‚ â”‚     Option B: Redis Pub/Sub    â”‚  â”‚
â”‚ â”‚     Option C: Poll DB          â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                          â”‚
â”‚          â–¼                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 13. Return 200 OK (ACK)        â”‚  â”‚
â”‚ â”‚     Pub/Sub marks delivered    â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Notification (WebSocket ou polling)
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORCHESTRATEUR                       â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 14. Retrieve response from DB   â”‚â”‚
â”‚ â”‚     SELECT * FROM messages      â”‚â”‚
â”‚ â”‚     WHERE id = $1               â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                        â”‚
â”‚           â–¼                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 15. Send via WebSocket          â”‚â”‚
â”‚ â”‚     ws.send({                   â”‚â”‚
â”‚ â”‚       type: "chat.message",     â”‚â”‚
â”‚ â”‚       role: "assistant",        â”‚â”‚
â”‚ â”‚       content: "...",           â”‚â”‚
â”‚ â”‚       agent_id: "anima",        â”‚â”‚
â”‚ â”‚       cost_usd: 0.0012          â”‚â”‚
â”‚ â”‚     })                          â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                        â”‚
â”‚           â–¼                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ 16. Update Redis cache          â”‚â”‚
â”‚ â”‚     redis.store_session_context â”‚â”‚
â”‚ â”‚       (session_id, messages)    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ WebSocket message
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚
â”‚ Browser â”‚ Displays response "Bonjour ! Comment puis-je vous aider ?"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Latences estimÃ©es** :
1. Orchestrator: 50ms (DB query + Pub/Sub publish)
2. Pub/Sub delivery: 10-50ms
3. Worker LLM call: 500-2000ms (Anthropic API)
4. Worker DB write: 20ms
5. WebSocket notification: 10ms

**Total p50** : ~1.5s
**Total p99** : ~3s (cold start worker + LLM latency)

---

## ğŸ“Š Flux 2 : RAG Document Query (pgvector)

### Recherche similaire avec embeddings

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚ "Explique le document X"
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORCHESTRATEUR                       â”‚
â”‚                                     â”‚
â”‚ 1. Check RAG enabled                â”‚
â”‚    rag_enabled = True               â”‚
â”‚                                     â”‚
â”‚ 2. Generate query embedding         â”‚
â”‚    embedding = sbert.encode(query)  â”‚
â”‚    # [0.123, -0.456, ..., 0.789]    â”‚
â”‚    # 384 dimensions                 â”‚
â”‚                                     â”‚
â”‚ 3. Check Redis cache                â”‚
â”‚    key = f"rag:query:{hash(query)}" â”‚
â”‚    cached = redis.get(key)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ Cache MISS
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLOUD SQL POSTGRESQL (pgvector)    â”‚
â”‚                                     â”‚
â”‚ 4. Vector search (cosine similarity)â”‚
â”‚                                     â”‚
â”‚ SELECT                              â”‚
â”‚   dc.id,                            â”‚
â”‚   dc.content,                       â”‚
â”‚   d.filename,                       â”‚
â”‚   (1 - (dc.embedding <=>            â”‚
â”‚         '[0.123,-0.456,...]'::vectorâ”‚
â”‚    ))::DECIMAL AS similarity        â”‚
â”‚ FROM document_chunks dc             â”‚
â”‚ JOIN documents d ON d.id = dc.doc_idâ”‚
â”‚ WHERE d.user_id = 'user@example.com'â”‚
â”‚   AND (1 - (dc.embedding <=>        â”‚
â”‚            query_vector))           â”‚
â”‚       >= 0.7  /* threshold */       â”‚
â”‚ ORDER BY                            â”‚
â”‚   dc.embedding <=> query_vector     â”‚
â”‚ LIMIT 5;                            â”‚
â”‚                                     â”‚
â”‚ Uses index:                         â”‚
â”‚   idx_chunks_embedding_ivfflat      â”‚
â”‚   (IVFFLAT with 100 lists)          â”‚
â”‚                                     â”‚
â”‚ Query time: ~50ms (index scan)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ Results: 5 chunks
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORCHESTRATEUR                       â”‚
â”‚                                     â”‚
â”‚ 5. Cache results in Redis           â”‚
â”‚    redis.set(                       â”‚
â”‚      key,                           â”‚
â”‚      json.dumps(results),           â”‚
â”‚      ex=300  # 5 min TTL            â”‚
â”‚    )                                â”‚
â”‚                                     â”‚
â”‚ 6. Build context for agent          â”‚
â”‚    rag_context = "\n\n".join([      â”‚
â”‚      f"[{r['filename']}]\n"         â”‚
â”‚      f"{r['content']}"              â”‚
â”‚      for r in results               â”‚
â”‚    ])                               â”‚
â”‚                                     â”‚
â”‚ 7. Include in agent payload         â”‚
â”‚    system_prompt = f"""             â”‚
â”‚      Context documents:             â”‚
â”‚      {rag_context}                  â”‚
â”‚                                     â”‚
â”‚      User question:                 â”‚
â”‚      {user_query}                   â”‚
â”‚    """                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ â†’ Pub/Sub â†’ Worker (see Flux 1)
          â–¼
```

**Optimisations pgvector** :

1. **Index IVFFLAT** : Partitionne espace vectoriel en 100 clusters
   - Recherche approximative (trade-off vitesse/prÃ©cision)
   - IdÃ©al pour >10K vectors
   - RecommandÃ©: `lists = sqrt(nb_rows)`

2. **Index HNSW (alternative)** : Graphe hierarchique
   - Meilleure prÃ©cision que IVFFLAT
   - Plus lent Ã  construire
   - IdÃ©al pour >100K vectors

3. **SimilaritÃ© cosine** : `<=>` operator
   - Distance : 0 = identique, 2 = opposÃ©
   - Similarity : `1 - distance`

---

## ğŸ“Š Flux 3 : Session Cache (Redis)

### Gestion session utilisateur avec TTL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚ Login successful
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ JWT issued (session_id: "uuid-123")
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORCHESTRATEUR                       â”‚
â”‚                                     â”‚
â”‚ 1. Create session context           â”‚
â”‚    context = {                      â”‚
â”‚      "user_id": "user@example.com", â”‚
â”‚      "session_id": "uuid-123",      â”‚
â”‚      "current_thread_id": "uuid-...",â”‚
â”‚      "rag_enabled": False,          â”‚
â”‚      "last_activity": timestamp     â”‚
â”‚    }                                â”‚
â”‚                                     â”‚
â”‚ 2. Store in Redis with TTL          â”‚
â”‚    redis.store_session_context(     â”‚
â”‚      session_id="uuid-123",         â”‚
â”‚      context=context,               â”‚
â”‚      ttl=1800  # 30 minutes         â”‚
â”‚    )                                â”‚
â”‚                                     â”‚
â”‚    Internally:                      â”‚
â”‚    SET session:uuid-123:context     â”‚
â”‚        '{"user_id":"...","..."}' EX 1800â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ User sends message (10 min later)
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORCHESTRATEUR                       â”‚
â”‚                                     â”‚
â”‚ 3. Retrieve session context         â”‚
â”‚    context = redis.get_session_     â”‚
â”‚              context("uuid-123")    â”‚
â”‚                                     â”‚
â”‚    Redis:                           â”‚
â”‚    GET session:uuid-123:context     â”‚
â”‚    â†’ Returns JSON (still valid)     â”‚
â”‚    â†’ TTL remaining: 1200s (20 min)  â”‚
â”‚                                     â”‚
â”‚ 4. Refresh TTL on activity          â”‚
â”‚    redis.expire(                    â”‚
â”‚      "session:uuid-123:context",    â”‚
â”‚      1800  # Reset to 30 min        â”‚
â”‚    )                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ User inactive for 30 minutes
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REDIS (Memorystore)                 â”‚
â”‚                                     â”‚
â”‚ 5. Key expired (TTL = 0)            â”‚
â”‚    DEL session:uuid-123:context     â”‚
â”‚                                     â”‚
â”‚    Memory freed (LRU eviction)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ User sends new message after expiration
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORCHESTRATEUR                       â”‚
â”‚                                     â”‚
â”‚ 6. Cache MISS                       â”‚
â”‚    context = redis.get_session_     â”‚
â”‚              context("uuid-123")    â”‚
â”‚    â†’ Returns None                   â”‚
â”‚                                     â”‚
â”‚ 7. Reload from PostgreSQL           â”‚
â”‚    SELECT * FROM sessions           â”‚
â”‚    WHERE id = 'uuid-123'            â”‚
â”‚                                     â”‚
â”‚ 8. Re-cache in Redis                â”‚
â”‚    redis.store_session_context(...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TTLs recommandÃ©s** :
- **Session context** : 30 min (refresh on activity)
- **RAG results** : 5 min (queries similaires frÃ©quentes)
- **Agent state** : 15 min (thinking, temporary data)
- **Rate limits** : 60s (sliding window)

---

## ğŸ“Š Flux 4 : Pub/Sub Dead Letter Queue (Retry Logic)

### Gestion erreurs avec retry automatique

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORCHESTRATEUR                       â”‚
â”‚ Publish message to Pub/Sub          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PUB/SUB TOPIC: agent-anima-tasks    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUBSCRIPTION: anima-worker-sub      â”‚
â”‚ ack_deadline: 600s (10 min)         â”‚
â”‚ retry_policy:                       â”‚
â”‚   min_backoff: 10s                  â”‚
â”‚   max_backoff: 600s                 â”‚
â”‚ max_delivery_attempts: 5            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORKER: Anima                       â”‚
â”‚                                     â”‚
â”‚ Attempt 1: Call Anthropic API       â”‚
â”‚ â†’ Error: 429 Rate Limit             â”‚
â”‚ â†’ Return 500 (no ACK)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Pub/Sub retry with backoff
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUBSCRIPTION (retry)                â”‚
â”‚ Wait: 10s (min_backoff)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORKER: Anima                       â”‚
â”‚                                     â”‚
â”‚ Attempt 2: Call Anthropic API       â”‚
â”‚ â†’ Error: 503 Service Unavailable    â”‚
â”‚ â†’ Return 500 (no ACK)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Pub/Sub retry with backoff
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUBSCRIPTION (retry)                â”‚
â”‚ Wait: 20s (exponential backoff)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORKER: Anima                       â”‚
â”‚                                     â”‚
â”‚ Attempt 3: Call Anthropic API       â”‚
â”‚ â†’ Success: 200 OK                   â”‚
â”‚ â†’ Store in DB                       â”‚
â”‚ â†’ Return 200 (ACK)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Message acknowledged
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUBSCRIPTION                        â”‚
â”‚ Message deleted from queue          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

=== Alternative: Max retries exceeded ===

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORKER: Anima                       â”‚
â”‚                                     â”‚
â”‚ Attempt 5: Call Anthropic API       â”‚
â”‚ â†’ Error: 500 Internal Error         â”‚
â”‚ â†’ Return 500 (no ACK)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Max delivery attempts reached (5)
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DEAD LETTER QUEUE: agent-tasks-dlq  â”‚
â”‚                                     â”‚
â”‚ Message moved to DLQ with metadata: â”‚
â”‚ {                                   â”‚
â”‚   "original_topic": "agent-anima...",â”‚
â”‚   "delivery_attempts": 5,           â”‚
â”‚   "last_error": "500 Internal",     â”‚
â”‚   "first_attempt_time": timestamp,  â”‚
â”‚   "last_attempt_time": timestamp    â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Alert monitoring team
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLOUD MONITORING ALERT              â”‚
â”‚                                     â”‚
â”‚ Alert: DLQ messages > 10            â”‚
â”‚ â†’ Send Slack notification           â”‚
â”‚ â†’ Page on-call engineer             â”‚
â”‚                                     â”‚
â”‚ Manual investigation:               â”‚
â”‚ - Check DLQ messages                â”‚
â”‚ - Analyze failure pattern           â”‚
â”‚ - Fix root cause (API outage, etc.) â”‚
â”‚ - Re-publish from DLQ if needed     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Retry strategy** :
- Attempt 1: ImmÃ©diate
- Attempt 2: +10s
- Attempt 3: +20s (exponential)
- Attempt 4: +40s
- Attempt 5: +80s
- â†’ DLQ after 5 Ã©checs (total ~2.5 min)

---

## ğŸ¯ RÃ©sumÃ© Performance

| OpÃ©ration | Latence p50 | Latence p99 | Throughput |
|-----------|-------------|-------------|------------|
| Chat message (cache hit) | 800ms | 1.5s | 500 req/s |
| Chat message (cache miss) | 1.5s | 3s | 200 req/s |
| RAG vector search | 50ms | 200ms | 1000 req/s |
| Session context (Redis) | 5ms | 20ms | 5000 req/s |
| Worker LLM call | 1s | 3s | 100 req/s/worker |

**ScalabilitÃ©** :
- Orchestrator : Auto-scale 1-10 instances (concurrent 80 req/instance)
- Workers : Auto-scale 0-10 instances (concurrent 10 req/instance)
- PostgreSQL : Connection pool 100 max, MVCC = 0 locks
- Redis : 1GB = ~10K sessions cached simultaneously

**ğŸ¤– Flux documentation gÃ©nÃ©rÃ© avec CodeSmith-AI**
