# D√©ploiement Production P1+P0

**Date** : 2025-10-10 04:03 CEST  
**Agent** : Codex  
**Type** : Release m√©moire Phase P1.2 + correctif P0  
**R√©vision d√©ploy√©e** : `emergence-app-p1-p0-20251010-040147`  
**Image** : `europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:p1-p0-20251010-040147`  
**Digest Cloud Run** : `sha256:28539718d838b238f136afe6bfdae6288bd82a7e2fba79f8c13edd416b0ff4f0`

---

## üéØ Objectif

Mettre en production les travaux combin√©s **Phase P1.2** (persistance des pr√©f√©rences dans ChromaDB) et **Phase P0** (consolidation automatique des threads archiv√©s) apr√®s validation FG.  
Ce d√©ploiement remplace la r√©vision `emergence-app-p1-1-hotfix` par une image construite sur le commit `654425a` (guide d√©ploiement P1+P0) incluant :

- `0c95f9f` ‚Äî Consolidation LTM pour threads archiv√©s (endpoint batch + hook async)
- `40ee8dc` ‚Äî Persistance des pr√©f√©rences utilisateur dans Vector DB
- Documentation associ√©e (prompts & guides de session P0/P1)

---

## üß± Build & Publication

```powershell
# 1. Build linux/amd64
docker build --platform linux/amd64 `
  -t emergence-app:p1-p0-20251010-040147 `
  -f Dockerfile .

# 2. Tag Artifact Registry
docker tag emergence-app:p1-p0-20251010-040147 `
  europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:p1-p0-20251010-040147

# 3. Push registry
gcloud auth configure-docker europe-west1-docker.pkg.dev
docker push europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:p1-p0-20251010-040147
```

---

## üöÄ D√©ploiement Cloud Run

```powershell
# 4. D√©ployer la nouvelle r√©vision
gcloud run deploy emergence-app `
  --image europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:p1-p0-20251010-040147 `
  --project emergence-469005 `
  --region europe-west1 `
  --platform managed `
  --allow-unauthenticated `
  --concurrency 40 `
  --cpu 2 `
  --memory 2Gi `
  --timeout 300 `
  --revision-suffix p1-p0-20251010-040147

# 5. Basculer le trafic
gcloud run services update-traffic emergence-app `
  --region europe-west1 `
  --to-revisions "emergence-app-p1-p0-20251010-040147=100,emergence-app-00279-kub=0"
```

R√©sultat :

- ‚úÖ R√©vision active : `emergence-app-p1-p0-20251010-040147`
- ‚úÖ Alias `canary` conserv√© sur `emergence-app-00279-kub` (0 %)
- ‚úÖ URL service : https://emergence-app-47nct44nma-ew.a.run.app

---

## ‚úÖ V√©rifications post-d√©ploiement

- `curl https://emergence-app-47nct44nma-ew.a.run.app/api/health` ‚Üí `{"status":"ok"}`
- `gcloud run services logs read emergence-app --limit 50`
  - `MemoryTaskQueue started with 2 workers`
  - `PreferenceExtractor sont pr√™ts`
  - Warnings AutoSyncService (fichiers docs manquants) identiques aux sessions pr√©c√©dentes
- `gcloud run revisions list --service emergence-app --region europe-west1`
  - Statut `Active: yes` pour `emergence-app-p1-p0-20251010-040147`

---

## ‚ö†Ô∏è Tests non ex√©cut√©s

- `tests/run_all.ps1` (login smoke requis) ‚Äî script `sync-workdir.ps1` √©choue sur l'√©tape auth comme attendu.
- Sc√©nario QA pr√©f√©rences (`scripts/qa/trigger_preferences_extraction.py`) non lanc√© faute de credentials.
- Migration batch `/api/memory/consolidate-archived` non ex√©cut√©e c√¥t√© prod (√† lancer apr√®s validation FG).

---

## üî≠ Actions de suivi recommand√©es

1. **Migration batch** : `POST /api/memory/consolidate-archived` (limit 1000) avec compte prod pour int√©grer l'historique.
2. **V√©rification pr√©f√©rences** : ex√©cuter le script QA afin de g√©n√©rer des m√©triques `memory_preferences_*` et valider l'appel `_save_preferences_to_vector_db`.
3. **Monitoring 24h** : surveiller Cloud Logging (erreurs `MemoryTaskQueue`, latence archiving) et Prometheus (latence archivage <200‚ÄØms, erreur <1‚ÄØ%).
4. **Documentation** : mettre √† jour cockpit/Grafana avec les panels P1 (voir `docs/monitoring/prometheus-p1-metrics.md`).

---

## üìö R√©f√©rences

- [Prompt d√©ploiement P1+P0](../../DEPLOY_P1_P0_PROMPT.md)
- [Rapport P1 m√©moire](2025-10-09-deploy-p1-memory.md)
- [Rapport hotfix P1.1](2025-10-09-hotfix-p1.1-preference-integration.md)
- [Analyse gaps m√©moire](../architecture/MEMORY_LTM_GAPS_ANALYSIS.md)
