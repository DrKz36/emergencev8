# 2025-10-18 — Déploiement beta-2.1.3 (Guardian Email Reports)

## Résumé
- **Version** : `beta-2.1.3` (Guardian Email Reports)
- **Image** : `europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:deploy-20251018-124633`
- **Digest** : `sha256:6c744022b59bf55819918e8c5ab4e79422ab17b5c711f5f6c22f16a523054eb3`
- **Révision Cloud Run** : `emergence-app-00490-xih`
- **Trafic** : 10% → 50% → 100% (progressif, 2025-10-18)
- **Tags** : `stable`, `canary-20251018`

## Préparation
### Versioning
- `src/version.js`, `src/frontend/version.js`, `package.json`, `index.html`, `src/backend/features/monitoring/router.py` synchronisés sur `beta-2.1.3`.
- Documentation mise à jour : `AGENT_SYNC.md`, `docs/AGENTS_COORDINATION.md`, `docs/INTER_AGENT_SYNC.md`, `docs/architecture/*`, `README.md`.

### Build & Tests
| Commande | Résultat | Notes |
|----------|----------|-------|
| `python -m pytest` | ❌ | 5 erreurs existantes (fixture/app manquante, capture pytest) |
| `ruff check` | ❌ | Infra existante (197 erreurs historiques, pas dans le périmètre) |
| `mypy src` | ❌ | Conflit module `backend.core.database.manager` (connu) |
| `npm run build` | ✅ | Build Vite OK (warnings import dynamique inchangé) |
| `pwsh -File tests/run_all.ps1` | ❌ | Échec authentification (identifiants smoke non fournis) |

_Remarque_ : les échecs signalés correspondent aux anomalies déjà documentées dans les sessions précédentes (pas de régression liée au bump version).

## Construction de l'image
```
docker build -t europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:deploy-20251018-124633 -t europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:latest .
docker push europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:deploy-20251018-124633
docker push europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:latest
```

## Déploiement Cloud Run
1. `gcloud run deploy emergence-app --image ...:deploy-20251018-124633 --no-traffic --tag=canary-20251018`
2. Routage progressif :
   - `gcloud run services update-traffic emergence-app --to-revisions=...00378-6sw=90,...00490-xih=10`
   - `gcloud run services update-traffic emergence-app --to-revisions=...00378-6sw=50,...00490-xih=50`
   - `gcloud run services update-traffic emergence-app --to-revisions=emergence-app-00490-xih=100`

### Vérifications canary (revision `00490-xih`)
- `curl https://canary-20251018---emergence-app-47nct44nma-ew.a.run.app/api/health` → `{"status":"ok"}`
- `curl -I https://canary-20251018---.../src/frontend/main.js` → `HTTP 200`
- `curl https://canary-20251018---.../` → HTML expose `beta-2.1.3`
- `gcloud logging read ...revision_name=emergence-app-00490-xih AND severity>=ERROR` → aucune erreur (fenêtre 10 min)

## État final
| Élément | Valeur |
|---------|--------|
| URL principale | https://emergence-app-47nct44nma-ew.a.run.app |
| URL stable tag | https://stable---emergence-app-47nct44nma-ew.a.run.app |
| URL canary tag | https://canary-20251018---emergence-app-47nct44nma-ew.a.run.app |
| Trafic | `00490-xih` = 100%, anciennes révisions = 0% |
| Health | Ready = True, RoutesReady = True |

## Suivi / Prochaines actions
1. Fournir credentials smoke (`EMERGENCE_SMOKE_EMAIL/PASSWORD`) pour réactiver `tests/run_all.ps1`.
2. Planifier correction backlog `pytest`/`ruff`/`mypy` (voir AGENT_SYNC tâches ouvertes).
3. Monitorer logs `severity>=ERROR` durant la fenêtre post-déploiement (30 min recommandées).

