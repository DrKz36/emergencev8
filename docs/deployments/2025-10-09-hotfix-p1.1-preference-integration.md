# Hotfix P1.1 - Int√©gration PreferenceExtractor

**Date** : 2025-10-09 19:30 CEST
**Agent** : Claude Code
**Type** : Correctif critique Phase P1
**R√©vision cible** : `emergence-app-p1.1-hotfix`

---

## üêõ Probl√®me identifi√©

### D√©couverte

Lors de la validation P1 en production (session 2025-10-09 18:15-19:30), d√©couverte que **PreferenceExtractor n'√©tait jamais appel√©** lors des consolidations m√©moire.

### Sympt√¥mes

- ‚úÖ Code `PreferenceExtractor` existe ([src/backend/features/memory/preference_extractor.py](../../src/backend/features/memory/preference_extractor.py))
- ‚úÖ Tests unitaires passent (8/8)
- ‚úÖ M√©triques instrument√©es (5 m√©triques Prometheus P1)
- ‚ùå **M√©triques `memory_preferences_*` jamais visibles en production**
- ‚ùå **Aucun log PreferenceExtractor dans Cloud Run**

### Cause racine

`PreferenceExtractor` n'√©tait **pas int√©gr√© dans `analyzer.py`**. Le code √©tait autonome mais jamais appel√© pendant le cycle de consolidation m√©moire.

**Impact** : Phase P1 partiellement d√©ploy√©e - infrastructure OK, extraction pr√©f√©rences non branch√©e.

---

## ‚úÖ Correctif appliqu√©

### Modifications code

**Fichier** : [src/backend/features/memory/analyzer.py](../../src/backend/features/memory/analyzer.py)

1. **Import PreferenceExtractor** (ligne 13):
   ```python
   from backend.features.memory.preference_extractor import PreferenceExtractor
   ```

2. **Initialisation dans `__init__`** (ligne 113):
   ```python
   self.preference_extractor: Optional[PreferenceExtractor] = None
   ```

3. **Instanciation dans `set_chat_service`** (ligne 120):
   ```python
   self.preference_extractor = PreferenceExtractor(llm_client=chat_service)
   ```

4. **Appel extraction apr√®s analyse s√©mantique** (lignes 360-402):
   - R√©cup√©ration `user_sub` depuis session metadata
   - Appel `await self.preference_extractor.extract(...)`
   - Log pr√©f√©rences extraites
   - M√©triques Prometheus incr√©ment√©es automatiquement

### Changements comportementaux

**Avant P1.1** :
1. Analyse s√©mantique (summary + concepts + entities)
2. ‚úÖ FIN

**Apr√®s P1.1** :
1. Analyse s√©mantique (summary + concepts + entities)
2. **‚ú® Extraction pr√©f√©rences/intentions/contraintes**
3. **‚ú® M√©triques P1 incr√©ment√©es**
4. ‚úÖ FIN

---

## üß™ Tests validation

### Tests unitaires

```bash
pytest tests/memory/test_preference_extractor.py -v
# 8/8 PASSED

pytest tests/memory/ -v -k "not archives"
# 15/15 PASSED
```

### Qualit√© code

```bash
mypy src/backend/features/memory/analyzer.py
# Success: no issues found

ruff check src/backend/features/memory/analyzer.py
# All checks passed!
```

---

## üì¶ D√©ploiement recommand√©

### √âtapes build/deploy

```bash
# 1. V√©rifier Git status propre
git status

# 2. Commit correctif
git add src/backend/features/memory/analyzer.py docs/deployments/
git commit -m "fix(P1.1): integrate PreferenceExtractor in memory consolidation

- Import PreferenceExtractor in analyzer.py
- Initialize in set_chat_service()
- Call extract() after semantic analysis
- Metrics memory_preferences_* now triggered
- Tests: 15/15 pass, mypy/ruff clean

Fixes: Phase P1 preference extraction non-functional"

# 3. Build image
timestamp=$(date +%Y%m%d-%H%M%S)
docker build --platform linux/amd64 \
  -t europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:p1.1-hotfix-$timestamp .

# 4. Push
docker push europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:p1.1-hotfix-$timestamp

# 5. Deploy avec suffix p1-1-hotfix
gcloud run deploy emergence-app \
  --image europe-west1-docker.pkg.dev/emergence-469005/app/emergence-app:p1.1-hotfix-$timestamp \
  --project emergence-469005 \
  --region europe-west1 \
  --platform managed \
  --allow-unauthenticated \
  --revision-suffix p1-1-hotfix

# 6. Basculer trafic
gcloud run services update-traffic emergence-app \
  --to-revisions emergence-app-p1-1-hotfix=100 \
  --project emergence-469005 \
  --region europe-west1
```

### Post-d√©ploiement

```bash
# 1. Health check
curl https://emergence-app-47nct44nma-ew.a.run.app/api/health

# 2. V√©rifier Workers P1
gcloud logging read \
  "resource.type=cloud_run_revision AND resource.labels.revision_name:p1-1-hotfix AND textPayload:MemoryTaskQueue" \
  --project emergence-469005 \
  --limit 5

# 3. D√©clencher extraction test
python scripts/qa/simple_preference_test.py

# 4. V√©rifier m√©triques P1 apparaissent
curl https://emergence-app-47nct44nma-ew.a.run.app/api/metrics | grep memory_preferences

# 5. V√©rifier logs PreferenceExtractor
gcloud logging read \
  "resource.type=cloud_run_revision AND resource.labels.revision_name:p1-1-hotfix AND textPayload:PreferenceExtractor" \
  --project emergence-469005 \
  --limit 20
```

---

## ‚úÖ Crit√®res succ√®s P1.1

- [ ] R√©vision `emergence-app-p1-1-hotfix` d√©ploy√©e (100% trafic)
- [ ] Logs "PreferenceExtractor: Extracted X preferences" visibles
- [ ] M√©triques `memory_preferences_extracted_total` > 0
- [ ] M√©triques `memory_preferences_llm_calls_total` > 0
- [ ] M√©triques `memory_preferences_confidence` histogram populated
- [ ] Tests QA passent (script `simple_preference_test.py`)

---

## üìä M√©triques attendues post-hotfix

Apr√®s consolidation avec pr√©f√©rences :

```prometheus
# Extraction
memory_preferences_extracted_total{type="preference"} 2.0
memory_preferences_extracted_total{type="intent"} 1.0

# Confidence distribution
memory_preferences_confidence_bucket{le="0.8"} 3
memory_preferences_confidence_bucket{le="0.9"} 3
memory_preferences_confidence_count 3

# Pipeline efficiency
memory_preferences_lexical_filtered_total 1
memory_preferences_llm_calls_total 3

# Latency
memory_preferences_extraction_duration_seconds_count 1
memory_preferences_extraction_duration_seconds_sum ~1.5
```

---

## üìù Notes techniques

### R√©cup√©ration user_sub

Le `user_sub` est r√©cup√©r√© depuis `session.user_id` via `session_manager.get_session()`. Si indisponible, l'extraction est skipp√©e avec warning log.

### Persistence Firestore

**TODO P1.2** : Sauvegarder `PreferenceRecord` dans Firestore collection `memory_preferences_{user_sub}`.

Pour l'instant, pr√©f√©rences extraites sont **logg√©es uniquement** (debug). M√©triques Prometheus sont incr√©ment√©es correctement.

### Fallback graceful

Si `PreferenceExtractor` √©choue (erreur LLM, timeout), l'analyse s√©mantique n'est **pas impact√©e**. Erreur logg√©e, consolidation continue.

---

## üîó R√©f√©rences

### Code modifi√©
- [src/backend/features/memory/analyzer.py](../../src/backend/features/memory/analyzer.py) (lignes 13, 113, 120, 360-402)

### Documentation
- [docs/monitoring/prometheus-p1-metrics.md](../monitoring/prometheus-p1-metrics.md) - Guide m√©triques complet
- [NEXT_SESSION_PROMPT.md](../../NEXT_SESSION_PROMPT.md) - Plan validation P1
- [SESSION_SUMMARY_20251009.md](../../SESSION_SUMMARY_20251009.md) - R√©sum√© session P1

### Scripts QA
- [scripts/qa/simple_preference_test.py](../../scripts/qa/simple_preference_test.py)
- [scripts/qa/trigger_preferences_extraction.py](../../scripts/qa/trigger_preferences_extraction.py)

---

**Derni√®re mise √† jour** : 2025-10-09 19:45 CEST
**Status** : Correctif pr√™t pour d√©ploiement
**Priorit√©** : üî¥ CRITIQUE (Phase P1 non-fonctionnelle sans ce hotfix)
