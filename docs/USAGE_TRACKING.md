# üìä USAGE TRACKING SYSTEM - Phase 2 Guardian Cloud

**Version:** 1.0.0
**Date:** 2025-10-19
**Status:** ‚úÖ IMPL√âMENT√â

---

## üéØ OBJECTIF

Syst√®me de tracking automatique de l'activit√© utilisateurs dans √âMERGENCE V8 pour :
- Monitorer l'usage des features
- D√©tecter les erreurs rencontr√©es par les utilisateurs
- G√©n√©rer des rapports d'activit√© pour dashboard admin
- **Privacy-compliant** : Aucun contenu sensible captur√©

---

## üèóÔ∏è ARCHITECTURE

### Composants cr√©√©s

```
src/backend/
‚îú‚îÄ‚îÄ features/usage/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py           # Pydantic models (UserSession, FeatureUsage, UserError)
‚îÇ   ‚îú‚îÄ‚îÄ repository.py       # UsageRepository (SQLite CRUD)
‚îÇ   ‚îú‚îÄ‚îÄ guardian.py         # UsageGuardian (agr√®ge stats)
‚îÇ   ‚îî‚îÄ‚îÄ router.py           # API endpoints (/api/usage/*)
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ usage_tracking.py   # UsageTrackingMiddleware (capture automatique)
```

### Tables SQLite

**`user_sessions`**
```sql
CREATE TABLE user_sessions (
    id TEXT PRIMARY KEY,
    user_email TEXT NOT NULL,
    session_start TEXT NOT NULL,
    session_end TEXT,
    duration_seconds INTEGER,
    ip_address TEXT,
    user_agent TEXT,
    created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
)
```

**`feature_usage`**
```sql
CREATE TABLE feature_usage (
    id TEXT PRIMARY KEY,
    user_email TEXT NOT NULL,
    feature_name TEXT NOT NULL,        -- Ex: "chat_message", "document_upload"
    endpoint TEXT NOT NULL,            -- Ex: "/api/chat/message"
    method TEXT NOT NULL DEFAULT 'GET',
    timestamp TEXT NOT NULL,
    success BOOLEAN NOT NULL DEFAULT 1,
    error_message TEXT,
    duration_ms INTEGER,
    status_code INTEGER NOT NULL DEFAULT 200,
    created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
)
```

**`user_errors`**
```sql
CREATE TABLE user_errors (
    id TEXT PRIMARY KEY,
    user_email TEXT NOT NULL,
    endpoint TEXT NOT NULL,
    method TEXT NOT NULL,
    error_type TEXT NOT NULL,
    error_code INTEGER NOT NULL,
    error_message TEXT NOT NULL,
    stack_trace TEXT,
    timestamp TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
)
```

---

## üîê PRIVACY COMPLIANCE

### ‚úÖ Ce qui EST captur√©

- Endpoint appel√© (ex: `/api/chat/message`)
- M√©thode HTTP (GET, POST, etc.)
- User email (depuis JWT)
- Timestamp
- Succ√®s/√âchec (status code)
- Dur√©e de la requ√™te (ms)
- Message d'erreur (si erreur)

### ‚ùå Ce qui N'EST PAS captur√©

- **Contenu des messages chat** (`/api/chat/message` body)
- **Contenu des fichiers upload√©s**
- **Mots de passe**
- **Tokens JWT complets**
- **Donn√©es sensibles dans query params**

Le middleware utilise `fire-and-forget` pour logger sans bloquer les requ√™tes.

---

## üöÄ UTILISATION

### Middleware (Automatique)

Le middleware `UsageTrackingMiddleware` est activ√© automatiquement dans `main.py` :

```python
from backend.middleware.usage_tracking import UsageTrackingMiddleware

app.add_middleware(UsageTrackingMiddleware)
```

**Il capture automatiquement TOUTES les requ√™tes API** (sauf health/metrics).

### Endpoint Admin: `/api/usage/summary`

**GET** `/api/usage/summary?hours=2`

**Acc√®s:** Admin only (`require_admin_claims`)

**Param√®tres:**
- `hours` (int, default=2) : Nombre d'heures √† analyser (1-720)

**R√©ponse:**
```json
{
  "period_start": "2025-10-19T14:00:00+00:00",
  "period_end": "2025-10-19T16:00:00+00:00",
  "active_users": 5,
  "total_requests": 1234,
  "total_errors": 12,
  "users": [
    {
      "email": "user@example.com",
      "total_time_minutes": 45,
      "features_used": ["chat_message", "documents_upload", "thread_create"],
      "requests_count": 234,
      "errors_count": 2,
      "errors": [
        {
          "endpoint": "/api/documents/upload",
          "error": "File too large",
          "timestamp": "2025-10-19T15:30:12+00:00",
          "code": 413
        }
      ]
    }
  ],
  "top_features": [
    {"name": "chat_message", "count": 567},
    {"name": "thread_create", "count": 123}
  ],
  "error_breakdown": {
    "400": 5,
    "500": 2,
    "503": 1
  }
}
```

### Endpoint: `/api/usage/generate-report`

**POST** `/api/usage/generate-report?hours=2`

**Acc√®s:** Admin only

G√©n√®re rapport ET le sauvegarde dans `reports/usage_report.json`

**R√©ponse:**
```json
{
  "status": "success",
  "report_path": "reports/usage_report.json",
  "summary": {
    "active_users": 5,
    "total_requests": 1234,
    "total_errors": 12,
    "period": "2025-10-19T14:00:00+00:00 -> 2025-10-19T16:00:00+00:00"
  }
}
```

### Endpoint: `/api/usage/health`

**GET** `/api/usage/health`

**Acc√®s:** Public

Health check du syst√®me usage tracking.

**R√©ponse:**
```json
{
  "status": "healthy",
  "service": "usage-tracking",
  "repository": "available"
}
```

---

## ü§ñ USAGEGUARDIAN AGENT

### M√©thodes principales

```python
from backend.features.usage.guardian import UsageGuardian
from backend.features.usage.repository import UsageRepository

# Initialiser
repository = UsageRepository(db_manager)
guardian = UsageGuardian(repository)

# G√©n√©rer rapport (2h par d√©faut)
report = await guardian.generate_report(hours=2)

# G√©n√©rer + sauvegarder fichier
report, path = await guardian.generate_and_save_report(hours=6)
# ‚Üí Cr√©e reports/usage_report.json
```

### Format rapport

```python
{
    "period_start": datetime,
    "period_end": datetime,
    "active_users": int,
    "total_requests": int,
    "total_errors": int,
    "users": [
        {
            "email": str,
            "total_time_minutes": int,
            "features_used": [str],
            "requests_count": int,
            "errors_count": int,
            "errors": [dict]
        }
    ],
    "top_features": [{"name": str, "count": int}],
    "error_breakdown": {"400": 5, "500": 2}
}
```

---

## üîó INT√âGRATION PHASE 5 (EMAIL GUARDIAN)

Le rapport usage sera int√©gr√© dans l'email Guardian (Phase 5).

Le template `guardian_report_email.html` a d√©j√† une section `{% if usage_stats %}` pr√™te :

```python
# Phase 5 appellera:
usage_report = load_report('usage_report.json')

await email_service.send_guardian_report(
    to_email="admin@example.com",
    reports={
        'prod_report.json': prod_data,
        'usage_stats': usage_report,  # ‚Üê Usage tracking ici
    }
)
```

---

## ‚ö° PERFORMANCE

### Overhead middleware

- **Target:** < 10ms par requ√™te
- **Impl√©mentation:** Fire-and-forget (asyncio.create_task)
- **Pas de await bloquant** dans le middleware

### Optimisations

- Index SQLite sur `timestamp` et `user_email`
- Logging asynchrone
- Skip des endpoints health/metrics
- Batch writes possibles (future)

---

## üß™ TESTS

### Test manuel du middleware

1. Lancer backend local :
   ```bash
   pwsh -File scripts/run-backend.ps1
   ```

2. Faire quelques requ√™tes API :
   ```bash
   curl http://localhost:8000/api/health
   curl -H "Authorization: Bearer <token>" http://localhost:8000/api/threads
   ```

3. V√©rifier tables SQLite :
   ```bash
   sqlite3 emergence_local.db "SELECT * FROM feature_usage ORDER BY timestamp DESC LIMIT 10"
   ```

### Test endpoint admin

```bash
# Login admin
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "xxx"}'

# R√©cup√©rer token JWT
export TOKEN="<jwt-token>"

# Appeler endpoint usage
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8000/api/usage/summary?hours=24"
```

### Test privacy compliance

**V√©rifier que le body n'est PAS captur√© :**

```bash
# Envoyer message chat
curl -X POST http://localhost:8000/api/chat/message \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"message": "SECRET MESSAGE", "session_id": "xxx"}'

# V√©rifier DB
sqlite3 emergence_local.db "SELECT * FROM feature_usage WHERE endpoint = '/api/chat/message'"

# ‚úÖ DOIT afficher:
# - endpoint: /api/chat/message
# - user_email: xxx
# - success: 1
# ‚ùå NE DOIT PAS afficher:
# - "SECRET MESSAGE" nulle part
```

---

## üìä DASHBOARD ADMIN (Future)

Le frontend int√©grera un dashboard admin pour visualiser les rapports usage :

- Graphique utilisateurs actifs (timeline)
- Top features utilis√©es (bar chart)
- Breakdown erreurs (pie chart)
- Liste utilisateurs avec d√©tails

**TODO Phase 3:** Cr√©er `src/frontend/features/admin/usage-dashboard.js`

---

## üö® ALERTES (Future Phase 5)

Le syst√®me pourra d√©clencher alertes si :
- Taux d'erreurs > 10% sur derni√®re heure
- Feature critique (chat) down
- Utilisateur rencontre 5+ erreurs en 10 min

**Int√©gration:** Email Guardian + notifications Slack (Phase 5)

---

## üîß MAINTENANCE

### Nettoyer vieilles donn√©es

```python
# TODO: Ajouter endpoint /api/usage/cleanup
# Supprime feature_usage > 90 jours
# Supprime user_errors > 30 jours
# Garde user_sessions ind√©finiment (ou 1 an)
```

### Migration Firestore (Phase 3+)

Actuellement SQLite, migration Firestore pr√©vue pour :
- Scalabilit√© cloud
- Requ√™tes distribu√©es
- Backup automatique

**TODO:** `UsageRepository` sera adapt√© pour Firestore (interface identique).

---

## üìù CHANGELOG

### v1.0.0 (2025-10-19) - Phase 2 Guardian Cloud

**Impl√©ment√©:**
- ‚úÖ UsageTrackingMiddleware (capture automatique)
- ‚úÖ UsageRepository (SQLite CRUD)
- ‚úÖ UsageGuardian (g√©n√©ration rapports)
- ‚úÖ Endpoint `/api/usage/summary` (admin only)
- ‚úÖ Endpoint `/api/usage/generate-report` (admin only)
- ‚úÖ Privacy compliance (pas de body captur√©)
- ‚úÖ Tables SQLite (user_sessions, feature_usage, user_errors)
- ‚úÖ Documentation compl√®te

**TODO Phase 3+:**
- [ ] Migration Firestore
- [ ] Dashboard admin frontend
- [ ] Alertes temps r√©el
- [ ] Cleanup automatique vieilles donn√©es
- [ ] Tests E2E

---

## ü§ù CONTRIBUTION AGENT

**Cr√©√© par:** Claude Code (Phase 2 Guardian Cloud)
**Date:** 2025-10-19
**Dur√©e:** 1 session (2h)

**Fichiers cr√©√©s:**
- `src/backend/features/usage/models.py` (96 lignes)
- `src/backend/features/usage/repository.py` (326 lignes)
- `src/backend/features/usage/guardian.py` (222 lignes)
- `src/backend/features/usage/router.py` (144 lignes)
- `src/backend/middleware/usage_tracking.py` (280 lignes)
- `docs/USAGE_TRACKING.md` (ce fichier)

**Total:** ~1068 lignes de code + documentation

---

**‚úÖ Phase 2 termin√©e - Pr√™t pour Phase 3 (Gmail API Integration) üöÄ**
