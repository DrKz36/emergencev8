"""
Send authentication issue email to selected beta testers
"""
import asyncio
import sys
import io
import os
from pathlib import Path

# Force UTF-8 encoding for console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

# Load .env file
from dotenv import load_dotenv
env_path = Path(__file__).parent / '.env'
load_dotenv(env_path)

from src.backend.features.auth.email_service import EmailService


# LISTE DES DESTINATAIRES - FOURNIE PAR L'ADMIN
RECIPIENTS = [
    "degeo81@gmail.com",
    "fernando36@bluewin.ch",
    "gonzalefernando@gmail.com",
    "pepin1936@gmail.com",
    "stephane.cola@bluewin.ch"
]


async def send_to_selected_members():
    """Send authentication issue notification to selected members"""

    base_url = "https://emergence-app.ch"

    print("=" * 80)
    print("ENVOI D'EMAILS AUX MEMBRES S√âLECTIONN√âS")
    print("=" * 80)
    print()
    print("üìß Type d'email : Notification probl√®me d'authentification")
    print(f"üåê Base URL : {base_url}")
    print()
    print("=" * 80)
    print("LISTE DES DESTINATAIRES")
    print("=" * 80)
    print()

    for i, email in enumerate(RECIPIENTS, 1):
        print(f"  {i}. {email}")

    print()
    print(f"üìä TOTAL : {len(RECIPIENTS)} destinataires")
    print()
    print("=" * 80)
    print()

    # CONFIRMATION REQUIRED
    print("‚ö†Ô∏è  ATTENTION : Vous √™tes sur le point d'envoyer cet email √† ces adresses.")
    print()
    confirmation = input("Confirmez-vous l'envoi √† ces adresses uniquement ? (oui/non) : ").strip().lower()

    if confirmation not in ['oui', 'yes', 'o', 'y']:
        print()
        print("‚ùå Envoi annul√© par l'utilisateur.")
        return False

    print()
    print("=" * 80)
    print("ENVOI EN COURS...")
    print("=" * 80)
    print()

    # Initialize email service
    email_service = EmailService()

    # Check if email service is enabled
    if not email_service.is_enabled():
        print("‚ùå ERREUR : Le service email n'est pas activ√© ou configur√©")
        return False

    results = {
        "total": len(RECIPIENTS),
        "sent": 0,
        "failed": 0,
        "sent_to": [],
        "failed_emails": []
    }

    for email in RECIPIENTS:
        try:
            print(f"üì§ Envoi √† {email}...", end=" ")

            success = await email_service.send_auth_issue_notification_email(
                to_email=email,
                base_url=base_url
            )

            if success:
                results["sent"] += 1
                results["sent_to"].append(email)
                print("‚úÖ Envoy√©")
            else:
                results["failed"] += 1
                results["failed_emails"].append(email)
                print("‚ùå √âchec")

        except Exception as e:
            results["failed"] += 1
            results["failed_emails"].append(email)
            print(f"‚ùå Erreur : {e}")

    print()
    print("=" * 80)
    print("R√âSULTATS DE L'ENVOI")
    print("=" * 80)
    print()
    print(f"üìä Total : {results['total']}")
    print(f"‚úÖ Envoy√©s : {results['sent']}")
    print(f"‚ùå √âchou√©s : {results['failed']}")
    print()

    if results['sent'] > 0:
        print("‚úÖ Emails envoy√©s avec succ√®s √† :")
        for email in results['sent_to']:
            print(f"   ‚Ä¢ {email}")
        print()

    if results['failed'] > 0:
        print("‚ùå Emails √©chou√©s pour :")
        for email in results['failed_emails']:
            print(f"   ‚Ä¢ {email}")
        print()

    print("=" * 80)

    return results['failed'] == 0


async def main():
    """Main function"""
    success = await send_to_selected_members()

    if not success:
        sys.exit(1)


if __name__ == "__main__":
    asyncio.run(main())
