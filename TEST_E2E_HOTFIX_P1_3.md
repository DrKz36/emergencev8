# Test End-to-End Local - Hotfix P1.3

Ce document d√©crit le sc√©nario de test end-to-end complet pour valider le Hotfix P1.3 en environnement local avant d√©ploiement production.

---

## üéØ Objectifs

1. V√©rifier que l'extraction de pr√©f√©rences fonctionne avec `user_id` en fallback
2. Valider que les pr√©f√©rences sont correctement sauvegard√©es dans ChromaDB local
3. Confirmer que les m√©triques Prometheus sont expos√©es
4. S'assurer qu'aucune r√©gression n'a √©t√© introduite

---

## ‚úÖ Pr√©-requis

- [x] Backend local d√©marr√©
- [x] ChromaDB local configur√© (./chroma_data)
- [x] Variables d'environnement configur√©es (.env)
- [x] Hotfix P1.3 appliqu√© (commit 74c34c1)

---

## üìã Sc√©nario de Test

### √âtape 1 : V√©rifier que le backend d√©marre sans erreur

```powershell
# Terminal 1 : D√©marrer le backend
pwsh -File scripts/run-backend.ps1
```

**V√©rifications** :
- ‚úÖ Backend d√©marre sur http://localhost:8000
- ‚úÖ Log : `MemoryAnalyzer V3.7 (P1) initialis√©. Pr√™t: True`
- ‚úÖ Log : `PreferenceExtractor` initialis√© sans erreur
- ‚úÖ Aucun warning/error au d√©marrage

**Si erreur** : V√©rifier les logs et corriger avant de continuer

---

### √âtape 2 : Tester extraction unitaire (d√©j√† fait ‚úÖ)

```powershell
python scripts/test_hotfix_p1_3_local.py
```

**R√©sultat attendu** :
```
‚úÖ TOUS LES TESTS SONT PASS√âS !
üöÄ Hotfix P1.3 pr√™t pour d√©ploiement production
```

**Status** : ‚úÖ PASS√â (5/5 tests)

---

### √âtape 3 : Test End-to-End via API

#### 3.1 - Health Check

```powershell
curl http://localhost:8000/api/health
```

**R√©sultat attendu** :
```json
{
  "status": "healthy",
  "version": "1.0.0",
  ...
}
```

#### 3.2 - Cr√©er une session WebSocket et envoyer des messages

**Option A : Via WebSocket client Python**

Cr√©er `scripts/test_e2e_preferences.py` :

```python
import asyncio
import websockets
import json

async def test_preference_extraction():
    # Connexion WebSocket
    uri = "ws://localhost:8000/api/chat/ws"

    async with websockets.connect(uri) as websocket:
        print("‚úÖ WebSocket connect√©")

        # Recevoir message session_established
        msg = await websocket.recv()
        print(f"üì® Re√ßu: {msg}")

        # Envoyer messages avec pr√©f√©rences
        messages = [
            {
                "type": "chat.message",
                "payload": {
                    "text": "Je pr√©f√®re utiliser Python avec FastAPI pour mes APIs",
                    "agent_id": "anima",
                    "use_rag": False
                }
            },
            {
                "type": "chat.message",
                "payload": {
                    "text": "J'aime beaucoup TypeScript pour le frontend",
                    "agent_id": "nexus",
                    "use_rag": False
                }
            },
            {
                "type": "chat.message",
                "payload": {
                    "text": "J'√©vite toujours les bases NoSQL pour les donn√©es critiques",
                    "agent_id": "anima",
                    "use_rag": False
                }
            }
        ]

        for msg_data in messages:
            await websocket.send(json.dumps(msg_data))
            print(f"üì§ Envoy√©: {msg_data['payload']['text'][:50]}...")

            # Attendre r√©ponse
            response = await websocket.recv()
            print(f"üì® R√©ponse re√ßue")

        print("\n‚úÖ 3 messages avec pr√©f√©rences envoy√©s")
        print("‚è≥ Fermeture WebSocket pour d√©clencher finalisation...")

        # Fermer WebSocket (d√©clenche session finalization)

asyncio.run(test_preference_extraction())
```

**Ex√©cuter** :
```powershell
python scripts/test_e2e_preferences.py
```

**Option B : Via DevTools navigateur**

1. Ouvrir http://localhost:3000 (frontend local)
2. Ouvrir DevTools ‚Üí Console
3. Envoyer messages via interface chat :
   - "Je pr√©f√®re utiliser Python avec FastAPI pour mes APIs"
   - "J'aime beaucoup TypeScript pour le frontend"
   - "J'√©vite toujours les bases NoSQL pour les donn√©es critiques"
4. Fermer l'onglet (d√©clenche session finalization)

---

### √âtape 4 : V√©rifier les logs backend

**Dans le terminal backend, chercher** :

‚úÖ **Logs attendus (SUCCESS)** :
```
[PreferenceExtractor] Extracted 3 preferences/intents for session XXX (user_sub=None, user_id=YYY)
[PreferenceExtractor] user_sub missing, using user_id=YYY as fallback (thread_id=ZZZ)
[PreferenceExtractor] Saved 3/3 preferences to ChromaDB for user YYY
```

‚ùå **Logs √† NE PAS voir (FAILURE)** :
```
[PreferenceExtractor] Cannot extract: user_sub not found for session XXX
ValueError: Cannot extract preferences: no user identifier
```

---

### √âtape 5 : Valider ChromaDB local

```powershell
python scripts/validate_preferences.py --limit 10
```

**R√©sultat attendu** :
```
üîç Validation ChromaDB - Collection 'memory_preferences'
üìÇ R√©pertoire: ./chroma_data
------------------------------------------------------------
‚úÖ Connexion ChromaDB √©tablie
‚úÖ Collection 'memory_preferences' trouv√©e
üìä Total pr√©f√©rences: 3 (ou plus)

üìã Affichage de 3 pr√©f√©rences:
------------------------------------------------------------

üîπ Pr√©f√©rence 1/3
   User: user_XXX (ou None si user_sub absent)
   Type: preference
   Topic: programmation
   Action: utiliser
   Sentiment: positive
   Confidence: 0.85
   Session: session_YYY
   Thread: thread_ZZZ
   Text: Je pr√©f√®re utiliser Python avec FastAPI...

üîπ Pr√©f√©rence 2/3
   ...

============================================================
‚úÖ Validation termin√©e avec succ√®s
```

**Si √©chec** :
- V√©rifier logs backend (erreurs extraction)
- V√©rifier chemin ChromaDB (./chroma_data)
- R√©essayer test E2E

---

### √âtape 6 : V√©rifier m√©triques Prometheus

```powershell
curl http://localhost:8000/api/metrics | Select-String "memory_preference"
```

**M√©triques attendues** :

‚úÖ **Succ√®s (valeurs > 0)** :
```
memory_preferences_extracted_total{type="preference"} 2.0
memory_preferences_extracted_total{type="intent"} 0.0
memory_preferences_extracted_total{type="constraint"} 1.0

memory_preferences_confidence_bucket{le="0.5"} 0.0
memory_preferences_confidence_bucket{le="0.8"} 1.0
memory_preferences_confidence_bucket{le="1.0"} 3.0

memory_preferences_extraction_duration_seconds_count 1.0
memory_preferences_extraction_duration_seconds_sum 0.523
```

‚úÖ **√âchecs (valeurs = 0)** :
```
memory_preference_extraction_failures_total{reason="user_identifier_missing"} 0.0
memory_preference_extraction_failures_total{reason="extraction_error"} 0.0
memory_preference_extraction_failures_total{reason="persistence_error"} 0.0
```

**Si m√©triques √©checs > 0** : V√©rifier logs pour identifier la cause

---

### √âtape 7 : Tests de r√©gression

```powershell
# Tous les tests m√©moire
python -m pytest tests/backend/features/ -k "memory" -v

# Tests sp√©cifiques hotfix
python -m pytest tests/backend/features/test_preference_extraction_context.py -v

# Tests extraction + persistence
python -m pytest tests/backend/features/test_memory_preferences_persistence.py -v
```

**R√©sultat attendu** :
- ‚úÖ Tous tests passants (0 √©checs)
- ‚úÖ Aucune r√©gression d√©tect√©e

---

## üéØ Checklist Validation Finale

Avant d√©ploiement production, v√©rifier :

### Tests unitaires
- [x] 8/8 tests hotfix passants
- [x] 49/49 tests m√©moire passants
- [x] 5/5 tests script local passants

### Tests E2E local
- [ ] Backend d√©marre sans erreur
- [ ] Session WebSocket fonctionne
- [ ] 3+ messages avec pr√©f√©rences envoy√©s
- [ ] Logs montrent extraction r√©ussie
- [ ] Logs montrent fallback user_id utilis√©
- [ ] ChromaDB contient pr√©f√©rences (count > 0)
- [ ] M√©triques Prometheus expos√©es
- [ ] M√©triques √©checs = 0
- [ ] Aucune r√©gression tests

### Logs backend
- [ ] `[PreferenceExtractor] Extracted X preferences`
- [ ] `[PreferenceExtractor] user_sub missing, using user_id=XXX`
- [ ] `[PreferenceExtractor] Saved X/X preferences to ChromaDB`
- [ ] AUCUNE erreur `user_sub not found`
- [ ] AUCUNE ValueError

### ChromaDB local
- [ ] Collection `memory_preferences` existe
- [ ] Count ‚â• 3 pr√©f√©rences
- [ ] Metadata contient `user_id` (et/ou `user_sub`)
- [ ] Metadata contient `session_id`, `thread_id`
- [ ] Metadata contient `type`, `topic`, `confidence`

### M√©triques
- [ ] `memory_preferences_extracted_total` > 0
- [ ] `memory_preference_extraction_failures_total` = 0
- [ ] `memory_preferences_confidence_*` pr√©sentes
- [ ] `memory_preferences_extraction_duration_seconds` pr√©sente

---

## üöÄ Apr√®s validation compl√®te

Si **TOUS** les points de la checklist sont coch√©s :

1. **Commit et push** :
   ```bash
   git push origin main
   ```

2. **D√©ployer en production** :
   ```bash
   gcloud builds submit --config cloudbuild.yaml
   ```

3. **R√©p√©ter validation en production** (voir ci-dessous)

---

## üîç Validation Production (Post-D√©ploiement)

### Logs production

```bash
gcloud run services logs read emergence-app --limit 200 | grep "PreferenceExtractor"
```

Chercher :
- ‚úÖ `[PreferenceExtractor] Extracted X preferences`
- ‚úÖ `[PreferenceExtractor] user_sub missing, using user_id=XXX`
- ‚ùå AUCUNE erreur `user_sub not found`

### M√©triques production

```bash
curl https://emergence-app-47nct44nma-ew.a.run.app/api/metrics | grep "memory_preference"
```

V√©rifier :
- `memory_preferences_extracted_total > 0`
- `memory_preference_extraction_failures_total = 0`

### ChromaDB production

‚ö†Ô∏è **Note** : ChromaDB production n'est pas directement accessible. Utiliser les logs backend pour confirmer :
- `[PreferenceExtractor] Saved X/X preferences to ChromaDB`

---

## üìö Troubleshooting

### Probl√®me : Backend ne d√©marre pas

**Solution** :
1. V√©rifier .env configur√©
2. V√©rifier d√©pendances : `pip install -r requirements.txt`
3. V√©rifier port 8000 libre : `netstat -ano | findstr :8000`

### Probl√®me : ChromaDB collection introuvable

**Solution** :
1. Supprimer ./chroma_data : `rm -r -force ./chroma_data`
2. Red√©marrer backend (recr√©e collections)
3. R√©essayer test E2E

### Probl√®me : M√©triques √©checs > 0

**Solution** :
1. V√©rifier logs backend : `reason="XXX"`
2. Si `user_identifier_missing` : v√©rifier session contient user_id
3. Si `extraction_error` : v√©rifier LLM API accessible
4. Si `persistence_error` : v√©rifier ChromaDB accessible

### Probl√®me : Tests E2E √©chouent

**Solution** :
1. V√©rifier logs backend (erreurs d√©taill√©es)
2. V√©rifier WebSocket connect√© correctement
3. V√©rifier messages envoy√©s contiennent mots-cl√©s pr√©f√©rences
4. R√©essayer avec d√©lai entre messages (rate limiting)

---

## ‚úÖ Validation R√©ussie

Si tous les tests locaux passent :
- ‚úÖ **Hotfix P1.3 valid√© localement**
- üöÄ **Pr√™t pour d√©ploiement production**
- üìã **Suivre proc√©dure d√©ploiement ci-dessus**

---

**Derni√®re mise √† jour** : 2025-10-10 14:45
**Status** : Tests unitaires ‚úÖ | E2E local ‚è≥ | Production ‚è≥
