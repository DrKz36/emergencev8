{% extends "email_base.html" %}

{% block title %}Guardian Report √âMERGENCE{% endblock %}

{% block extra_styles %}
/* Guardian-specific styles */
.section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border-left: 4px solid #3b82f6;
}
.section-title {
    color: #3b82f6;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.status-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    color: white;
}
.status-ok { background: #10b981; }
.status-warning { background: #f59e0b; }
.status-critical { background: #ef4444; }
.status-unknown { background: #6b7280; }

.metric {
    margin: 12px 0;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.metric:last-child {
    border-bottom: none;
}
.metric-label {
    color: #94a3b8;
    font-size: 14px;
}
.metric-value {
    color: #e2e8f0;
    font-weight: 600;
    font-size: 18px;
    margin-top: 4px;
}

.recommendations {
    background: rgba(251, 191, 36, 0.1);
    border-left: 4px solid #f59e0b;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}
.recommendations-title {
    color: #f59e0b;
    font-weight: 600;
    margin-bottom: 10px;
}

.details-section {
    background: rgba(239, 68, 68, 0.1);
    border-left: 4px solid #ef4444;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}
.details-title {
    color: #ef4444;
    font-weight: 600;
    font-size: 18px;
    margin-bottom: 15px;
}
.problem-item {
    background: rgba(0, 0, 0, 0.2);
    padding: 12px;
    border-radius: 6px;
    margin: 10px 0;
}
.problem-priority {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 8px;
}
.priority-CRITICAL { background: #dc2626; color: white; }
.priority-HIGH { background: #f59e0b; color: white; }
.priority-MEDIUM { background: #3b82f6; color: white; }
.priority-LOW { background: #6b7280; color: white; }

.log-sample {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.15);
    border-radius: 8px;
    padding: 12px 14px;
    margin: 12px 0;
}
.log-sample-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    color: #cbd5f5;
    font-size: 13px;
}
.log-sample-severity {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
}
.log-sample-message {
    font-family: monospace;
    background: rgba(0, 0, 0, 0.35);
    border-radius: 6px;
    padding: 10px;
    color: #e2e8f0;
    font-size: 12px;
    white-space: pre-wrap;
    overflow-x: auto;
}
.log-sample-meta {
    font-size: 12px;
    color: #94a3b8;
    margin: 4px 0;
}
.log-sample-payload {
    font-family: monospace;
    background: rgba(30, 41, 59, 0.6);
    padding: 8px;
    border-radius: 6px;
    margin-top: 8px;
    color: #cbd5e1;
    font-size: 11px;
    white-space: pre-wrap;
    overflow-x: auto;
}

.timestamp {
    color: #94a3b8;
    font-size: 14px;
    margin-top: 10px;
}
{% endblock %}

{% block header_title %}üõ°Ô∏è Guardian √âMERGENCE V8{% endblock %}

{% block header_subtitle %}
<p class="header-subtitle">Rapport de Monitoring Automatique</p>
<p class="timestamp">{{ timestamp }}</p>
<div style="margin-top: 15px;">
    {% if global_status == 'OK' %}
    <span class="status-badge status-ok">‚úÖ {{ global_status }}</span>
    {% elif global_status == 'WARNING' %}
    <span class="status-badge status-warning">‚ö†Ô∏è {{ global_status }}</span>
    {% elif global_status == 'CRITICAL' %}
    <span class="status-badge status-critical">üö® {{ global_status }}</span>
    {% else %}
    <span class="status-badge status-unknown">‚ùì {{ global_status }}</span>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<!-- Executive Summary -->
<div class="section">
    <div class="section-title">
        <span>üìä Executive Summary</span>
    </div>
    <div class="metric">
        <div class="metric-label">Statut Global</div>
        <div class="metric-value">{{ global_status }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Probl√®mes Critiques</div>
        <div class="metric-value">{{ summary.critical_count | default(0) }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Avertissements</div>
        <div class="metric-value">{{ summary.warning_count | default(0) }}</div>
    </div>
    {% if summary.active_users is defined %}
    <div class="metric">
        <div class="metric-label">Utilisateurs Actifs</div>
        <div class="metric-value">{{ summary.active_users }}</div>
    </div>
    {% endif %}
</div>

<!-- Production Guardian -->
{% if prod_report %}
<div class="section">
    <div class="section-title">
        <span>‚òÅÔ∏è Production Cloud Run</span>
        {% set prod_status = prod_report.status | default('UNKNOWN') %}
        {% if prod_status == 'OK' %}
        <span class="status-badge status-ok">‚úÖ {{ prod_status }}</span>
        {% elif prod_status == 'WARNING' %}
        <span class="status-badge status-warning">‚ö†Ô∏è {{ prod_status }}</span>
        {% elif prod_status == 'CRITICAL' %}
        <span class="status-badge status-critical">üö® {{ prod_status }}</span>
        {% else %}
        <span class="status-badge status-unknown">‚ùì {{ prod_status }}</span>
        {% endif %}
    </div>

    {% if prod_report.summary %}
    <div class="metric">
        <div class="metric-label">Logs Analys√©s</div>
        <div class="metric-value">{{ prod_report.logs_analyzed | default(prod_report.summary.total_logs) | default(0) }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Erreurs D√©tect√©es</div>
        <div class="metric-value">{{ prod_report.summary.errors | default(prod_report.summary.error_count) | default(0) }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Warnings</div>
        <div class="metric-value">{{ prod_report.summary.warnings | default(prod_report.summary.warning_count) | default(0) }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Probl√®mes Critiques</div>
        <div class="metric-value">{{ prod_report.summary.critical_signals | default(prod_report.summary.critical_count) | default(0) }}</div>
    </div>
    {% endif %}

    <!-- ERROR PATTERNS ANALYSIS (NEW - enriched data) -->
    {% if prod_report.error_patterns and (prod_report.error_patterns.by_endpoint or prod_report.error_patterns.by_error_type or prod_report.error_patterns.by_file) %}
    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div class="metric-label" style="font-size: 16px; color: #3b82f6; margin-bottom: 15px;">üîç Analyse de Patterns</div>

        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            {% if prod_report.error_patterns.by_endpoint %}
            <tr>
                <td style="padding: 8px 0; vertical-align: top; width: 30%; color: #94a3b8; font-size: 13px;">
                    <strong>Par Endpoint:</strong>
                </td>
                <td style="padding: 8px 0; color: #e2e8f0; font-size: 13px;">
                    {% for endpoint, count in (prod_report.error_patterns.by_endpoint.items() | list)[:3] %}
                    <div style="margin: 4px 0;">
                        <span style="background: rgba(59, 130, 246, 0.2); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">{{ endpoint }}</span>
                        <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 8px;">{{ count }}</span>
                    </div>
                    {% endfor %}
                </td>
            </tr>
            {% endif %}

            {% if prod_report.error_patterns.by_error_type %}
            <tr>
                <td style="padding: 8px 0; vertical-align: top; color: #94a3b8; font-size: 13px;">
                    <strong>Par Type d'Erreur:</strong>
                </td>
                <td style="padding: 8px 0; color: #e2e8f0; font-size: 13px;">
                    {% for error_type, count in (prod_report.error_patterns.by_error_type.items() | list)[:3] %}
                    <div style="margin: 4px 0;">
                        <span style="background: rgba(239, 68, 68, 0.2); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">{{ error_type }}</span>
                        <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 8px;">{{ count }}</span>
                    </div>
                    {% endfor %}
                </td>
            </tr>
            {% endif %}

            {% if prod_report.error_patterns.by_file %}
            <tr>
                <td style="padding: 8px 0; vertical-align: top; color: #94a3b8; font-size: 13px;">
                    <strong>Par Fichier:</strong>
                </td>
                <td style="padding: 8px 0; color: #e2e8f0; font-size: 13px;">
                    {% for file_path, count in (prod_report.error_patterns.by_file.items() | list)[:3] %}
                    <div style="margin: 4px 0;">
                        <span style="background: rgba(251, 191, 36, 0.2); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">{{ file_path }}</span>
                        <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 8px;">{{ count }}</span>
                    </div>
                    {% endfor %}
                </td>
            </tr>
            {% endif %}
        </table>
    </div>
    {% endif %}

    <!-- DETAILED ERRORS (NEW - enriched data) -->
    {% if prod_report.errors_detailed and prod_report.errors_detailed | length > 0 %}
    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div class="metric-label" style="font-size: 16px; color: #ef4444; margin-bottom: 15px;">‚ùå Erreurs D√©taill√©es (Top 3)</div>

        {% for error in prod_report.errors_detailed[:3] %}
        <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 15px; border-radius: 6px; margin: 15px 0;">
            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">
                <strong>‚è∞ {{ error.timestamp }}</strong>
                {% if error.severity %}
                <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px;">{{ error.severity }}</span>
                {% endif %}
            </div>

            {% if error.endpoint %}
            <div style="margin: 8px 0; font-size: 13px;">
                <span style="color: #94a3b8;">üåê Endpoint:</span>
                <span style="background: rgba(59, 130, 246, 0.2); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #4a9eff;">
                    {{ error.http_method }} {{ error.endpoint }}
                </span>
                {% if error.status_code %}
                <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px;">{{ error.status_code }}</span>
                {% endif %}
            </div>
            {% endif %}

            {% if error.error_type %}
            <div style="margin: 8px 0; font-size: 13px;">
                <span style="color: #94a3b8;">‚ö†Ô∏è Type:</span>
                <span style="background: rgba(239, 68, 68, 0.2); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #ff6b6b;">{{ error.error_type }}</span>
            </div>
            {% endif %}

            {% if error.file_path %}
            <div style="margin: 8px 0; font-size: 13px;">
                <span style="color: #94a3b8;">üìÅ Fichier:</span>
                <span style="background: rgba(251, 191, 36, 0.2); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #ffaa00;">
                    {{ error.file_path }}{% if error.line_number %}:{{ error.line_number }}{% endif %}
                </span>
            </div>
            {% endif %}

            <div style="margin-top: 12px;">
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;"><strong>üí¨ Message:</strong></div>
                <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; color: #e2e8f0; white-space: pre-wrap; overflow-x: auto;">{{ error.message[:500] }}{% if error.message | length > 500 %}...{% endif %}</div>
            </div>

            {% if error.stack_trace %}
            <div style="margin-top: 12px;">
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;"><strong>üìö Stack Trace:</strong></div>
                <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; color: #e2e8f0; white-space: pre-wrap; overflow-x: auto;">{{ error.stack_trace[:700] }}{% if error.stack_trace | length > 700 %}...{% endif %}</div>
            </div>
            {% endif %}

            {% if error.request_id %}
            <div style="margin-top: 8px; font-size: 12px; color: #94a3b8;">
                üîç Request ID: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">{{ error.request_id }}</code>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- CODE SNIPPETS (NEW - enriched data) -->
    {% if prod_report.code_snippets and prod_report.code_snippets | length > 0 %}
    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div class="metric-label" style="font-size: 16px; color: #f59e0b; margin-bottom: 15px;">üíª Code Suspect (Fichiers avec erreurs)</div>

        {% for snippet in prod_report.code_snippets[:2] %}
        <div style="background: rgba(251, 191, 36, 0.1); border-left: 3px solid #f59e0b; padding: 15px; border-radius: 6px; margin: 15px 0;">
            <div style="color: #ffaa00; font-size: 14px; font-weight: 600; margin-bottom: 8px;">
                üìÅ {{ snippet.file }}
                <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">{{ snippet.error_count }} erreurs</span>
            </div>
            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">
                Ligne {{ snippet.line }} (lignes {{ snippet.start_line }}-{{ snippet.end_line }})
            </div>
            <div style="background: rgba(0, 0, 0, 0.4); padding: 12px; border-radius: 4px; font-family: monospace; font-size: 11px; color: #c9d1d9; white-space: pre-wrap; overflow-x: auto; border: 1px solid rgba(255,255,255,0.1);">{{ snippet.code_snippet }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- RECENT COMMITS (NEW - enriched data) -->
    {% if prod_report.recent_commits and prod_report.recent_commits | length > 0 %}
    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div class="metric-label" style="font-size: 16px; color: #3b82f6; margin-bottom: 15px;">üîÄ Commits R√©cents (Coupables Potentiels)</div>

        {% for commit in prod_report.recent_commits[:3] %}
        <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #3b82f6;">
            <div style="font-family: monospace; font-size: 12px;">
                <span style="color: #4a9eff; font-weight: 600;">{{ commit.hash }}</span>
                <span style="color: #94a3b8;"> by </span>
                <span style="color: #ffaa00;">{{ commit.author }}</span>
                <span style="color: #94a3b8; font-size: 11px;"> ({{ commit.time }})</span>
            </div>
            <div style="color: #e2e8f0; font-size: 13px; margin-top: 6px;">{{ commit.message }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if prod_report.log_samples %}
    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div class="metric-label" style="font-size: 16px; color: #38bdf8; margin-bottom: 15px;">üìú Extraits de logs (derni√®re analyse)</div>

        {% for log in prod_report.log_samples[:5] %}
        {% set severity = log.severity | default('DEFAULT') %}
        {% set severity_color = '#6b7280' %}
        {% if severity in ['CRITICAL', 'ERROR', 'ALERT', 'EMERGENCY'] %}
            {% set severity_color = '#ef4444' %}
        {% elif severity in ['WARNING', 'WARN', 'DEGRADED'] %}
            {% set severity_color = '#f59e0b' %}
        {% elif severity in ['INFO', 'NOTICE'] %}
            {% set severity_color = '#0ea5e9' %}
        {% elif severity in ['DEBUG'] %}
            {% set severity_color = '#64748b' %}
        {% endif %}

        <div class="log-sample">
            <div class="log-sample-header">
                <span class="log-sample-severity" style="background: {{ severity_color }}; color: #0f172a;">
                    {{ severity }}
                </span>
                <span class="log-sample-meta">{{ log.timestamp }}</span>
            </div>

            {% if log.endpoint %}
            <div class="log-sample-meta">
                üåê {{ log.http_method | default('GET') }} {{ log.endpoint }}{% if log.status_code %} ‚Üí {{ log.status_code }}{% endif %}
            </div>
            {% endif %}

            {% if log.request_id %}
            <div class="log-sample-meta">
                üßæ Request ID: <code style="background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 4px;">{{ log.request_id }}</code>
            </div>
            {% endif %}

            <div class="log-sample-message">{{ log.message | default('') }}</div>

            {% if log.payload_excerpt %}
            <div class="log-sample-payload">{{ log.payload_excerpt }}{% if log.payload_excerpt|length == 500 %}...{% endif %}</div>
            {% endif %}
        </div>
        {% endfor %}

        {% if prod_report.log_samples | length > 5 %}
        <div class="log-sample-meta" style="margin-top: 12px;">
            ... {{ prod_report.log_samples | length - 5 }} autres entr√©es disponibles dans le rapport JSON.
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if prod_report.recommendations %}
    <div class="recommendations">
        <div class="recommendations-title">üìã Recommandations</div>
        <ul>
        {% for rec in prod_report.recommendations[:3] %}
            <li>[{{ rec.priority }}] {{ rec.action }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Documentation (Anima) -->
{% if docs_report %}
<div class="section">
    <div class="section-title">
        <span>üìö Documentation (Anima)</span>
        {% set docs_status = docs_report.status | default('UNKNOWN') %}
        {% if docs_status == 'OK' %}
        <span class="status-badge status-ok">‚úÖ {{ docs_status }}</span>
        {% elif docs_status in ['WARNING', 'NEEDS_UPDATE'] %}
        <span class="status-badge status-warning">‚ö†Ô∏è {{ docs_status }}</span>
        {% elif docs_status == 'CRITICAL' %}
        <span class="status-badge status-critical">üö® {{ docs_status }}</span>
        {% else %}
        <span class="status-badge status-unknown">‚ùì {{ docs_status }}</span>
        {% endif %}
    </div>

    {% if docs_report.summary %}
    <div class="metric">
        <div class="metric-label">Gaps D√©tect√©s</div>
        <div class="metric-value">{{ docs_report.summary.total_gaps | default(0) }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Mises √† Jour Propos√©es</div>
        <div class="metric-value">{{ docs_report.summary.proposed_updates | default(0) }}</div>
    </div>
    {% endif %}

    {% if docs_report.recommendations %}
    <div class="recommendations">
        <div class="recommendations-title">üìã Recommandations</div>
        <ul>
        {% for rec in docs_report.recommendations[:3] %}
            <li>[{{ rec.priority }}] {{ rec.action }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Int√©grit√© (Neo) -->
{% if integrity_report %}
<div class="section">
    <div class="section-title">
        <span>üîê Int√©grit√© Syst√®me (Neo)</span>
        {% set integrity_status = integrity_report.status | default('UNKNOWN') %}
        {% if integrity_status == 'OK' %}
        <span class="status-badge status-ok">‚úÖ {{ integrity_status }}</span>
        {% elif integrity_status == 'WARNING' %}
        <span class="status-badge status-warning">‚ö†Ô∏è {{ integrity_status }}</span>
        {% elif integrity_status == 'CRITICAL' %}
        <span class="status-badge status-critical">üö® {{ integrity_status }}</span>
        {% else %}
        <span class="status-badge status-unknown">‚ùì {{ integrity_status }}</span>
        {% endif %}
    </div>

    {% if integrity_report.summary %}
    <div class="metric">
        <div class="metric-label">Probl√®mes Critiques</div>
        <div class="metric-value">{{ integrity_report.summary.critical_count | default(0) }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Warnings</div>
        <div class="metric-value">{{ integrity_report.summary.warning_count | default(0) }}</div>
    </div>
    {% endif %}

    {% if integrity_report.recommendations %}
    <div class="recommendations">
        <div class="recommendations-title">üìã Recommandations</div>
        <ul>
        {% for rec in integrity_report.recommendations[:3] %}
            <li>[{{ rec.priority }}] {{ rec.action }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Rapport Unifi√© (Nexus) -->
{% if unified_report %}
<div class="section">
    <div class="section-title">
        <span>üéØ Rapport Unifi√© (Nexus)</span>
        {% set unified_status = unified_report.status | default('UNKNOWN') %}
        {% if unified_status == 'OK' %}
        <span class="status-badge status-ok">‚úÖ {{ unified_status }}</span>
        {% elif unified_status == 'WARNING' %}
        <span class="status-badge status-warning">‚ö†Ô∏è {{ unified_status }}</span>
        {% elif unified_status == 'CRITICAL' %}
        <span class="status-badge status-critical">üö® {{ unified_status }}</span>
        {% else %}
        <span class="status-badge status-unknown">‚ùì {{ unified_status }}</span>
        {% endif %}
    </div>

    {% if unified_report.priority_actions %}
    <div class="metric">
        <div class="metric-label">Actions Prioritaires</div>
        <div class="metric-value">{{ unified_report.priority_actions | length }}</div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Usage Stats (si disponible) -->
{% if usage_stats %}
<div class="section">
    <div class="section-title">
        <span>üë• Statistiques d'Utilisation (2h)</span>
    </div>

    <div class="metric">
        <div class="metric-label">Utilisateurs Actifs</div>
        <div class="metric-value">{{ usage_stats.summary.active_users_count | default(0) }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Requ√™tes Totales</div>
        <div class="metric-value">{{ usage_stats.summary.total_requests | default(0) }}</div>
    </div>
    <div class="metric">
        <div class="metric-label">Erreurs Utilisateurs</div>
        <div class="metric-value">{{ usage_stats.summary.total_errors | default(0) }}</div>
    </div>

    <!-- Top Features Utilis√©es -->
    {% if usage_stats.top_features and usage_stats.top_features | length > 0 %}
    <div style="margin-top: 20px;">
        <div class="metric-label">üî• Top Features Utilis√©es</div>
        <ul style="margin-top: 10px; padding-left: 20px; color: #e2e8f0;">
        {% for feature in usage_stats.top_features[:5] %}
            <li style="margin: 8px 0;">
                <strong>{{ feature.feature_name }}</strong>
                <span style="color: #94a3b8;">({{ feature.count }} fois)</span>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- D√©tail par Utilisateur -->
    {% if usage_stats.user_details and usage_stats.user_details | length > 0 %}
    <div style="margin-top: 20px;">
        <div class="metric-label">üë§ Activit√© par Utilisateur</div>
        <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(255,255,255,0.05); color: #3b82f6;">
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.1);">Email</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.1);">Features</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.1);">Dur√©e</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.1);">Erreurs</th>
                </tr>
            </thead>
            <tbody>
            {% for user in usage_stats.user_details[:10] %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; color: #e2e8f0;">{{ user.user_email }}</td>
                    <td style="padding: 10px; color: #94a3b8;">{{ user.unique_features_count | default(0) }}</td>
                    <td style="padding: 10px; color: #94a3b8;">{{ user.total_duration_minutes | default(0) }} min</td>
                    <td style="padding: 10px; color: {{ '#ef4444' if user.error_count > 0 else '#10b981' }};">
                        {{ user.error_count | default(0) }}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- D√©tails des Probl√®mes -->
{% if all_problems and all_problems | length > 0 %}
<div class="details-section">
    <div class="details-title">üìã D√©tails des Corrections Recommand√©es</div>

    {% for problem in all_problems[:10] %}
    <div class="problem-item">
        <span class="problem-priority priority-{{ problem.priority }}">{{ problem.priority }}</span>
        <strong>{{ problem.source }}</strong>
        <div style="margin-top:8px;">{{ problem.action }}</div>
        {% if problem.file %}
        <div style="margin-top:5px; color:#94a3b8; font-size:13px;">üìÑ {{ problem.file }}</div>
        {% endif %}
    </div>
    {% endfor %}

    {% if all_problems | length > 10 %}
    <div style="margin-top:15px; color:#94a3b8; font-size:14px;">
        ... et {{ all_problems | length - 10 }} autres probl√®mes d√©tect√©s
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Quick Links -->
<div class="section">
    <div class="section-title">
        <span>üîó Liens Rapides</span>
    </div>
    <div style="margin-top: 15px;">
        <a href="{{ admin_ui_url }}" class="button" style="color: white;">üéõÔ∏è Admin Dashboard</a>
        <a href="{{ cloud_storage_url }}" class="button button-secondary" style="color: white;">üì¶ Rapports Complets</a>
    </div>
    {% if cloud_logging_url %}
    <div style="margin-top: 10px;">
        <a href="{{ cloud_logging_url }}" style="color: #3b82f6; font-size: 14px;">üìä Cloud Logging Console</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block footer %}
<p><strong>ü§ñ Guardian Autonomous Monitoring System</strong></p>
<p>√âMERGENCE V8 - Rapports automatiques toutes les 2h</p>
<p style="margin-top: 15px;">
    üìß Contact : emergence.app.ch@gmail.com
</p>
{% endblock %}
